<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, viewport-fit=cover" />
<title>Carta Digital</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  /* --- COLORES Y VARIABLES --- */
  --brand-color: #FF4757; 
  --bg-body: #f8fafc;
  --bg-card: #ffffff;
  --text-main: #1e293b;
  --text-sec: #64748b;
  --border: #e2e8f0;
  --shadow-card: 0 4px 20px -5px rgba(0,0,0,0.05);
  --shadow-float: 0 15px 35px -5px rgba(0,0,0,0.15);
}

/* --- MODO OSCURO (NEGROS Y GRISES REALES) --- */
[data-theme="dark"] {
  --bg-body: #121212;
  --bg-card: #1e1e1e;
  --text-main: #f5f5f5;
  --text-sec: #aaaaaa;
  --border: #333333;
  --shadow-card: 0 4px 20px -5px rgba(0,0,0,0.5);
}

html { touch-action: manipulation; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; background: var(--bg-body); color: var(--text-main); 
  font-family: 'Outfit', sans-serif; transition: background 0.3s ease; 
  padding-bottom: 140px; -webkit-font-smoothing: antialiased;
}

/*HEADER*/
.header {
  background: rgba(255, 255, 255, 0.95); padding: 15px 20px; 
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; z-index: 800; border-bottom: 1px solid var(--border);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  transition: background 0.3s ease;
}
[data-theme="dark"] .header { background: rgba(18, 18, 18, 0.95); }

.brand-area { display: flex; flex-direction: column; align-items: flex-start; }
.brand-name { font-size: 1.3rem; font-weight: 800; color: var(--text-main); margin: 0; line-height: 1.1; text-transform: uppercase; letter-spacing: 2px; }

.header-right { display: flex; align-items: center; gap: 10px; }
.lang-badge {
    font-weight: 700; border: 2px solid var(--text-main); padding: 5px 8px; 
    border-radius: 8px; font-size: 0.8rem; cursor: default; letter-spacing: 1px; opacity: 0.8;
}

.theme-btn { 
  background: var(--bg-card); border: 1px solid var(--border); cursor: pointer; padding: 0; 
  color: var(--text-main); display: flex; align-items: center; justify-content: center;
  width: 36px; height: 36px; border-radius: 50%; font-size: 1.1rem; transition: transform 0.2s;
}
.theme-btn:active { transform: scale(0.9); }

/* CONTROLES */
.controls-container {
  position: sticky; top: 62px; z-index: 790; background: var(--bg-body);
  padding: 10px 0; border-bottom: 1px solid transparent; transition: background 0.3s ease, border-color 0.3s;
}
.allergy-wrapper { padding: 0 20px 10px 20px; }
.allergy-select {
  width: 100%; appearance: none; -webkit-appearance: none;
  background: var(--bg-card); border: 1px solid var(--border); 
  color: var(--text-main); font-size: 0.9rem; font-weight: 500;
  padding: 12px 16px; border-radius: 12px; cursor: pointer; outline: none;
  box-shadow: var(--shadow-card);
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 10px auto;
}
.filters-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 0 20px; scrollbar-width: none; }
.filters-scroll::-webkit-scrollbar { display: none; }
.filter-pill {
  padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border); 
  border-radius: 50px; white-space: nowrap; font-size: 0.9rem; font-weight: 600; 
  color: var(--text-sec); cursor: pointer; transition: all 0.2s;
}
.filter-pill.active { color: #fff; background: var(--brand-color); border-color: var(--brand-color); box-shadow: 0 4px 12px -3px var(--brand-color); }

/* MENU */
.menu-grid { display: flex; flex-direction: column; gap: 15px; padding: 10px 20px; max-width: 800px; margin: 0 auto; }
.dish-card {
  background: var(--bg-card); border-radius: 16px; padding: 16px;
  display: grid; grid-template-columns: 1fr auto; gap: 15px;
  box-shadow: var(--shadow-card); align-items: start;
}
.dish-info { display: flex; flex-direction: column; gap: 5px; }
.dish-name { font-weight: 700; font-size: 1.05rem; line-height: 1.3; color: var(--text-main); display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
.dish-desc { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.9; }
.dish-price { font-weight: 700; font-size: 1rem; color: var(--text-main); margin-top: 5px; }

.allergy-badge { 
  font-size: 0.85rem; background: rgba(0,0,0,0.05); padding: 2px 6px; 
  border-radius: 6px; display: inline-flex; align-items: center; gap: 3px; 
}
[data-theme="dark"] .allergy-badge { background: rgba(255,255,255,0.1); }

.action-area { display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-start; min-width: 90px; }
.btn-add-simple {
  background: rgba(0,0,0,0.03); color: var(--brand-color); font-weight: 700; font-size: 0.9rem;
  padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; width: 100%;
}
[data-theme="dark"] .btn-add-simple { background: rgba(255,255,255,0.05); }

.qty-selector {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--bg-body); border: 1px solid var(--border); border-radius: 8px; padding: 3px; width: 100%;
}
.qty-selector button {
  width: 28px; height: 28px; border-radius: 6px; border: none; background: var(--bg-card); color: var(--text-main);
  font-weight: 700; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
}
.qty-selector button.plus { color: var(--brand-color); }
.qty-selector span { font-weight: 600; font-size: 0.95rem; }

/* CESTA FLOTANTE */
#cart-float {
  position: fixed; 
  bottom: calc(30px + env(safe-area-inset-bottom)); 
  left: 50%; 
  transform: translateX(-50%) translateY(200px) scale(0.9);
  background: var(--text-main); color: var(--bg-card); padding: 14px 24px; border-radius: 100px; 
  display: flex; align-items: center; gap: 12px; justify-content: center;
  box-shadow: var(--shadow-float); cursor: pointer; z-index: 1000; 
  transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
  font-weight: 600; font-size: 1rem; width: max-content;
}
#cart-float.visible { transform: translateX(-50%) translateY(0) scale(1); }
.badge-count { background: var(--brand-color); color: #fff; padding: 3px 9px; border-radius: 50px; font-size: 0.8rem; font-weight: 800; }

/* MODAL */
.overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
  z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; justify-content: center; align-items: flex-end;
}
.overlay.open { opacity: 1; pointer-events: auto; }

.sheet {
  background: var(--bg-card); width: 100%; max-width: 600px; max-height: 85vh; border-radius: 24px 24px 0 0;
  padding: 25px; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
  box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
}
.overlay.open .sheet { transform: translateY(0); }

.sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
.sheet-title { margin: 0; font-size: 1.3rem; font-weight: 700; }
.close-small { cursor:pointer; padding:5px; font-size:1.5rem; }

.order-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
.order-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-body); border-radius: 12px; }
.order-name { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }

textarea.notes {
  width: 100%; padding: 15px; border-radius: 12px; background: var(--bg-body); border: 2px solid var(--border);
  color: var(--text-main); font-family: inherit; resize: none; outline: none; margin-bottom: 15px; font-size: 0.95rem;
}
textarea.notes:focus { border-color: var(--brand-color); }

.btn-action-wrapper { display: flex; flex-direction: column; gap: 10px; }
.btn-waiter {
  width: 100%; padding: 18px; border-radius: 16px; 
  background: var(--text-main); color: var(--bg-card); border: none; font-weight: 800; font-size: 1.1rem; cursor: pointer; 
  display: flex; align-items: center; justify-content: center; gap: 10px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  transform-origin: center; animation: pulse 2s infinite;
}
@keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.02);} 100% {transform: scale(1);} }

.clear-btn { background: transparent; border: none; color: var(--text-sec); text-decoration: underline; cursor: pointer; align-self: center; font-size: 0.9rem; margin-top: 5px;}

/* MODO CAMARERO */
.sheet.waiter-mode { 
  height: 100% !important; max-height: 100vh; border-radius: 0; z-index: 3000; padding-top: 60px; 
  background: #fff; color: #000;
}
.sheet.waiter-mode .order-item { padding: 25px 5px; background: transparent; border-bottom: 2px solid #eee; border-radius: 0; }
.sheet.waiter-mode .order-name { font-size: 1.8rem; font-weight: 800; line-height: 1.1; color: #000; }
.sheet.waiter-mode .qty-display { font-size: 2.2rem; font-weight: 900; color: var(--brand-color); margin-right: 25px; }

.waiter-note-box {
  background: #FFF8E1; border: 3px solid #FFD54F; color: #000;
  padding: 20px; margin: 20px 0; border-radius: 16px; font-size: 1.4rem;
  line-height: 1.4; font-weight: 500;
}
.waiter-note-label { font-weight: 900; display: block; margin-bottom: 8px; text-transform: uppercase; font-size: 0.9rem; color: #FFA000; letter-spacing: 1px; }

#closeWaiterBtn {
  position: absolute; top: 20px; right: 20px; width: 50px; height: 50px; background: #FF4757; color: #fff;
  border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 3001;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3); border: none; font-weight: bold;
}
</style>
</head>
<body>

<header class="header">
  <div class="brand-area">
    <h1 class="brand-name" id="brandNameDisplay">CARTA</h1>
  </div>
  <div class="header-right">
    <div class="lang-badge" id="langDisplay">ES</div>
    <button class="theme-btn" id="themeBtn">‚òÄÔ∏è</button>
  </div>
</header>

<div class="controls-container">
  <div class="allergy-wrapper">
    <select id="allergyFilter" class="allergy-select" onchange="render()">
      <option value="" id="opt-all">üå± Ver todo (Sin filtros)</option>
      <option value="g" id="opt-gf">üåæ Ocultar platos con Gluten</option>
      <option value="l" id="opt-lf">ü•õ Ocultar platos con Lactosa</option>
      <option value="n" id="opt-nuts">ü•ú Ocultar platos con Frutos Secos</option>
    </select>
  </div>

  <div class="filters-scroll">
    <button class="filter-pill active" onclick="filter('bebidas')" id="f-drk">Bebidas</button>
    <button class="filter-pill" onclick="filter('entrantes')" id="f-ent">Entrantes</button>
    <button class="filter-pill" onclick="filter('principales')" id="f-main">Principales</button>
    <button class="filter-pill" onclick="filter('postres')" id="f-des">Postres</button>
  </div>
</div>

<div class="menu-grid" id="menuContainer"></div>

<div id="cart-float" onclick="openSheet()">
  <span class="badge-count" id="countBadge">0</span>
  <span id="btnText">Ver Pedido</span>
</div>

<div class="overlay" id="overlay" onclick="if(event.target===this) closeSheet()">
  <button id="closeWaiterBtn" onclick="exitWaiterMode()">‚úï</button>

  <div class="sheet" id="orderSheet">
    <div class="sheet-header">
      <h3 class="sheet-title" id="modalTitle">Tu Pedido</h3>
      <div class="close-small" id="userCloseBtn" onclick="closeSheet()">‚úï</div>
    </div>
    
    <div class="order-list" id="orderList"></div>

    <div id="notesArea">
      <textarea class="notes" id="notesField" oninput="saveNotes()"></textarea>
    </div>
    
    <div id="waiterNotesDisplay" style="display:none;"></div>

    <div class="btn-action-wrapper">
      <button class="btn-waiter" id="btnShowWaiter" style="display:none;" onclick="enterWaiterMode()">
        <span id="btnWaiterText">üó£Ô∏è Mostrar al Camarero</span>
      </button>
      
      <button onclick="clearCart()" class="clear-btn" id="clearTxt">Borrar todo</button>
    </div>
  </div>
</div>

<script>
/* --- BASE DE DATOS COMPLETA --- 
   Tags de Al√©rgenos (Lo que CONTIENE el plato):
   'g' = Gluten (üçû)
   'l' = Lactosa (ü•õ)
   'n' = Frutos Secos (ü•ú)
*/
const config = {
  menus: {
    'restaurante': [
       /* ENTRANTES */
       { 
         id: 101, cat: 'entrantes', tags: ['g', 'l'], price: 10.50, emojis: "üçû ü•õ", 
         name: {es:"Croquetas Caseras", en:"Homemade Croquettes", de:"Hausgemachte Kroketten", fr:"Croquettes Maison", it:"Crocchette Fatte in Casa"}, 
         desc: {es:"De jam√≥n ib√©rico (8 uds)", en:"Iberian Ham (8 pcs)", de:"Iberischer Schinken (8 Stk)", fr:"Jambon Ib√©rique (8 pcs)", it:"Prosciutto Iberico (8 pz)"} 
       },
       { 
         id: 102, cat: 'entrantes', tags: ['g'], price: 16.00, emojis: "üçû",
         name: {es:"Jam√≥n Ib√©rico", en:"Iberian Ham", de:"Iberischer Schinken", fr:"Jambon Ib√©rique", it:"Prosciutto Iberico"}, 
         desc: {es:"Raci√≥n completa con picos", en:"Full portion with breadsticks", de:"Ganze Portion", fr:"Portion compl√®te", it:"Porzione completa"} 
       },
       { 
         id: 103, cat: 'entrantes', tags: [], price: 8.50, emojis: "",
         name: {es:"Ensalada Mixta", en:"Mixed Salad", de:"Gemischter Salat", fr:"Salade Mixte", it:"Insalata Mista"}, 
         desc: {es:"Lechuga, tomate, cebolla, at√∫n", en:"Lettuce, tomato, onion, tuna", de:"Salat, Tomate, Zwiebel, Thunfisch", fr:"Laitue, tomate, oignon, thon", it:"Lattuga, pomodoro, cipolla, tonno"} 
       },
       { 
         id: 104, cat: 'entrantes', tags: [], price: 6.50, emojis: "",
         name: {es:"Patatas Bravas", en:"Patatas Bravas", de:"Patatas Bravas", fr:"Patatas Bravas", it:"Patatas Bravas"}, 
         desc: {es:"Salsa picante casera", en:"Spicy homemade sauce", de:"Scharfe hausgemachte So√üe", fr:"Sauce piquante maison", it:"Salsa piccante fatta in casa"} 
       },

       /* PRINCIPALES */
       { 
         id: 201, cat: 'principales', tags: [], price: 19.50, emojis: "",
         name: {es:"Solomillo de Ternera", en:"Beef Tenderloin", de:"Rinderfilet", fr:"Filet de B≈ìuf", it:"Filetto di Manzo"}, 
         desc: {es:"A la parrilla con patatas", en:"Grilled with potatoes", de:"Gegrillt mit Kartoffeln", fr:"Grill√© avec pommes de terre", it:"Alla griglia con patate"} 
       },
       { 
         id: 202, cat: 'principales', tags: ['g'], price: 15.00, emojis: "üçû",
         name: {es:"Merluza a la Romana", en:"Battered Hake", de:"Seehecht im Teigmantel", fr:"Merlu √† la Romaine", it:"Nasello alla Romana"}, 
         desc: {es:"Rebozada, con ensalada", en:"Battered, with salad", de:"Paniert, mit Salat", fr:"Pann√©e, avec salade", it:"Impanato, con insalata"} 
       },
       { 
         id: 203, cat: 'principales', tags: ['g', 'l'], price: 12.50, emojis: "üçû ü•õ",
         name: {es:"Hamburguesa Completa", en:"Full Burger", de:"Vollst√§ndiger Burger", fr:"Burger Complet", it:"Hamburger Completo"}, 
         desc: {es:"Ternera, queso, bacon, huevo", en:"Beef, cheese, bacon, egg", de:"Rindfleisch, K√§se, Speck, Ei", fr:"B≈ìuf, fromage, bacon, ≈ìuf", it:"Manzo, formaggio, bacon, uovo"} 
       },
       { 
         id: 204, cat: 'principales', tags: ['g'], price: 14.00, emojis: "üçû",
         name: {es:"Carrillada en Salsa", en:"Braised Pork Cheeks", de:"Geschmorte Schweineb√§ckchen", fr:"Joues de Porc Brais√©es", it:"Guance di Maiale Brasate"}, 
         desc: {es:"Salsa ligada con harina", en:"Sauce thickened with flour", de:"So√üe mit Mehl gebunden", fr:"Sauce li√©e √† la farine", it:"Salsa legata con farina"} 
       },

       /* POSTRES */
       { 
         id: 301, cat: 'postres', tags: ['l'], price: 4.50, emojis: "ü•õ",
         name: {es:"Arroz con Leche", en:"Rice Pudding", de:"Milchreis", fr:"Riz au Lait", it:"Riso al Latte"}, 
         desc: {es:"Casero con canela", en:"Homemade with cinnamon", de:"Hausgemacht mit Zimt", fr:"Fait maison √† la cannelle", it:"Fatto in casa con cannella"} 
       },
       { 
         id: 302, cat: 'postres', tags: ['l'], price: 4.00, emojis: "ü•õ",
         name: {es:"Flan de Huevo", en:"Egg Flan", de:"Eierflan", fr:"Flan aux ≈íufs", it:"Creme Caramel"}, 
         desc: {es:"Receta de la abuela", en:"Grandma's recipe", de:"Omas Rezept", fr:"Recette de grand-m√®re", it:"Ricetta della nonna"} 
       },
       { 
         id: 303, cat: 'postres', tags: ['g', 'l'], price: 5.50, emojis: "üçû ü•õ",
         name: {es:"Tarta de Queso", en:"Cheesecake", de:"K√§sekuchen", fr:"G√¢teau au Fromage", it:"Cheesecake"}, 
         desc: {es:"Base de galleta", en:"Biscuit base", de:"Keksboden", fr:"Base de biscuit", it:"Base di biscotto"} 
       },
       { 
         id: 304, cat: 'postres', tags: ['g', 'l', 'n'], price: 6.00, emojis: "üçû ü•õ ü•ú",
         name: {es:"Brownie con Nueces", en:"Walnut Brownie", de:"Brownie mit Waln√ºssen", fr:"Brownie aux Noix", it:"Brownie alle Noci"}, 
         desc: {es:"Con nueces y helado", en:"With walnuts and ice cream", de:"Mit Waln√ºssen und Eis", fr:"Avec noix et glace", it:"Con noci e gelato"} 
       }
    ],
    'comunes': [
       /* BEBIDAS */
       { 
         id: 901, cat: 'bebidas', tags: [], price: 2.50, emojis: "",
         name: {es:"Coca-Cola / Refresco", en:"Coke / Soft Drink", de:"Cola / Erfrischungsgetr√§nk", fr:"Coca / Boisson Gazeuse", it:"Coca-Cola / Bibita"}, 
         desc: {es:"33cl", en:"33cl", de:"33cl", fr:"33cl", it:"33cl"} 
       },
       { 
         id: 902, cat: 'bebidas', tags: [], price: 2.00, emojis: "",
         name: {es:"Agua Mineral", en:"Mineral Water", de:"Mineralwasser", fr:"Eau Min√©rale", it:"Acqua Minerale"}, 
         desc: {es:"Botella 50cl", en:"50cl Bottle", de:"50cl Flasche", fr:"Bouteille 50cl", it:"Bottiglia 50cl"} 
       },
       { 
         id: 903, cat: 'bebidas', tags: ['g'], price: 2.80, emojis: "üçû",
         name: {es:"Ca√±a de Cerveza", en:"Draft Beer", de:"Bier vom Fass", fr:"Bi√®re Pression", it:"Birra alla Spina"}, 
         desc: {es:"Contiene cebada", en:"Contains barley", de:"Enth√§lt Gerste", fr:"Contient de l'orge", it:"Contiene orzo"} 
       },
       { 
         id: 904, cat: 'bebidas', tags: [], price: 3.50, emojis: "",
         name: {es:"Copa de Vino", en:"Glass of Wine", de:"Glas Wein", fr:"Verre de Vin", it:"Calice di Vino"}, 
         desc: {es:"Rioja o Ribera", en:"Red Wine", de:"Rotwein", fr:"Vin rouge", it:"Vino rosso"} 
       }
    ]
  }
};

/* --- DICCIONARIO UI COMPLETO --- */
const uiDict = {
  es: { 
    pageTitle: "CARTA", ent:"Entrantes", main:"Principales", des:"Postres", drk:"Bebidas", 
    btn:"Ver Pedido", title:"Tu Pedido", clear:"Borrar todo", trans:"Mostrar al Camarero", 
    add: "A√±adir", place: "Notas (ej. sin hielo, muy hecho...)",
    all: "üå± Ver todo (Sin filtros)", gf: "üåæ Ocultar platos con Gluten", lf: "ü•õ Ocultar platos con Lactosa", nuts: "ü•ú Ocultar platos con Frutos Secos"
  },
  en: { 
    pageTitle: "MENU", ent:"Starters", main:"Mains", des:"Desserts", drk:"Drinks", 
    btn:"View Order", title:"Your Order", clear:"Clear all", trans:"Show Waiter (ES)", 
    add: "Add", place: "Notes (e.g. no ice, well done...)",
    all: "üå± View all", gf: "üåæ Hide dishes with Gluten", lf: "ü•õ Hide dishes with Dairy", nuts: "ü•ú Hide dishes with Nuts"
  },
  de: { 
    pageTitle: "SPEISEKARTE", ent:"Vorspeisen", main:"Hauptgerichte", des:"Dessert", drk:"Getr√§nke", 
    btn:"Bestellung", title:"Deine Bestellung", clear:"L√∂schen", trans:"Kellner zeigen (ES)", 
    add: "Hinzuf√ºgen", place: "Notizen (z.B. kein Eis...)",
    all: "üå± Alle anzeigen", gf: "üåæ Gerichte mit Gluten ausblenden", lf: "ü•õ Gerichte mit Laktose ausblenden", nuts: "ü•ú Gerichte mit N√ºssen ausblenden"
  },
  fr: { 
    pageTitle: "CARTE", ent:"Entr√©es", main:"Plats", des:"Desserts", drk:"Boissons", 
    btn:"Voir Commande", title:"Votre Commande", clear:"Tout effacer", trans:"Montrer au Serveur (ES)", 
    add: "Ajouter", place: "Notes (ex. sans glace...)",
    all: "üå± Voir tout", gf: "üåæ Masquer plats avec Gluten", lf: "ü•õ Masquer plats avec Lactose", nuts: "ü•ú Masquer plats avec Fruits √† Coque"
  },
  it: { 
    pageTitle: "MENU", ent:"Antipasti", main:"Piatti Principali", des:"Dolci", drk:"Bevande", 
    btn:"Vedi Ordine", title:"Il Tuo Ordine", clear:"Cancella tutto", trans:"Mostra al Cameriere (ES)", 
    add: "Aggiungi", place: "Note (es. senza ghiaccio...)",
    all: "üå± Vedi tutto", gf: "üåæ Nascondi piatti con Glutine", lf: "ü•õ Nascondi piatti con Lattosio", nuts: "ü•ú Nascondi piatti con Frutta a Guscio"
  }
};

/* --- ESTADO --- */
let cart = {};
let activeCategory = 'bebidas'; 
let lang = 'es';
let currentMenu = [];
let userCategory = 'restaurante';

/* --- INIT --- */
function init() {
  const params = new URLSearchParams(window.location.search);
  
  // 1. GESTI√ìN DEL IDIOMA
  const urlLang = params.get('lang');
  const browserLang = navigator.language.slice(0,2);
  let detectedLang = urlLang || localStorage.getItem('userLang') || browserLang;
  
  const supportedLangs = ['es','en','de','fr','it'];
  lang = supportedLangs.includes(detectedLang) ? detectedLang : 'es';
  
  try { localStorage.setItem('userLang', lang); } catch (e) {}
  document.getElementById('langDisplay').innerText = lang.toUpperCase();
  
  // 2. COLOR DIN√ÅMICO
  const colorParam = params.get('btn') || params.get('color'); 
  if(colorParam) {
    document.documentElement.style.setProperty('--brand-color', '#' + colorParam.replace('#',''));
    const style = document.createElement('style');
    style.innerHTML = `#closeWaiterBtn { background: #${colorParam.replace('#','')} !important; }`;
    document.head.appendChild(style);
  }
  
  // 3. CARGA DE MENU
  userCategory = params.get('categoria') || 'restaurante';
  const specificMenu = config.menus[userCategory] || config.menus['restaurante'];
  const comunes = config.menus['comunes'] || [];
  currentMenu = [...specificMenu, ...comunes];

  loadCart();
  translateUI();
  activeCategory = 'bebidas';
  updateFilterUI();
  render();
  updateFloat();
  applyTheme();
}

/* --- RENDERIZADO DEL MENU --- */
function render() {
  const container = document.getElementById('menuContainer');
  container.innerHTML = '';
  // allergyFilter ahora es el al√©rgeno que el usuario NO quiere ver
  const allergyFilter = document.getElementById('allergyFilter').value; 
  
  const t = uiDict[lang] || uiDict['es'];
  const addBtnText = t.add || "A√±adir";

  const items = currentMenu.filter(item => {
    if(item.cat !== activeCategory) return false;
    // Si el filtro de alergia est√° activo, y el plato CONTIENE ese al√©rgeno, lo OCULTAMOS
    if(allergyFilter && item.tags && item.tags.includes(allergyFilter)) return false;
    return true;
  });

  if (items.length === 0) {
      container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sec); opacity:0.7">No hay platos que cumplan tu selecci√≥n.</div>`;
  }

  items.forEach(p => {
    const qty = cart[p.id] || 0;
    
    // Traducci√≥n
    const pName = p.name[lang] || p.name['es'];
    const pDesc = p.desc[lang] || p.desc['es'];
    
    // Si tiene emojis hardcodeados (inventados para este ejemplo)
    let emojisHTML = '';
    if (p.emojis && p.emojis.trim() !== '') {
        emojisHTML = `<span class="allergy-badge">${p.emojis}</span>`;
    }

    let controlHTML = qty === 0 
      ? `<button class="btn-add-simple" onclick="add(${p.id})">${addBtnText}</button>`
      : `<div class="qty-selector"><button onclick="remove(${p.id})">-</button><span>${qty}</span><button class="plus" onclick="add(${p.id})">+</button></div>`;

    container.innerHTML += `
      <div class="dish-card">
        <div class="dish-info">
          <div class="dish-name">${pName} ${emojisHTML}</div>
          <div class="dish-desc">${pDesc}</div>
          <div class="dish-price">${p.price.toFixed(2)}‚Ç¨</div>
        </div>
        <div class="action-area">${controlHTML}</div>
      </div>
    `;
  });
}

function filter(cat) {
  activeCategory = cat;
  updateFilterUI();
  render();
}

function updateFilterUI() {
  document.querySelectorAll('.filter-pill').forEach(el => el.classList.remove('active'));
  const map = { 'bebidas':'f-drk', 'entrantes':'f-ent', 'principales':'f-main', 'postres':'f-des' };
  if(map[activeCategory]) document.getElementById(map[activeCategory]).classList.add('active');
}

/* --- FUNCIONES DEL CARRITO --- */
function add(id) { 
  cart[id] = (cart[id] || 0) + 1; 
  saveCart(); render(); updateFloat(); 
  if(document.querySelector('.overlay.open')) renderList(); 
}

function remove(id) { 
  if(cart[id]) { 
    cart[id]--; 
    if(cart[id] <= 0) delete cart[id]; 
  } 
  saveCart(); render(); updateFloat(); 
  if(document.querySelector('.overlay.open')) renderList(); 
}

function updateFloat() {
  const count = Object.values(cart).reduce((a,b)=>a+b,0);
  document.getElementById('countBadge').innerText = count;
  
  const t = uiDict[lang] || uiDict['es'];
  document.getElementById('btnText').innerText = t.btn;

  const btn = document.getElementById('cart-float');
  count > 0 ? btn.classList.add('visible') : btn.classList.remove('visible');
}

function openSheet() { 
  document.getElementById('overlay').classList.add('open'); 
  const waiterBtn = document.getElementById('btnShowWaiter');
  if (lang !== 'es') waiterBtn.style.display = 'flex';
  else waiterBtn.style.display = 'none';
  renderList();
}

function closeSheet() { 
  exitWaiterMode();
  document.getElementById('overlay').classList.remove('open'); 
}

function renderList() {
  const list = document.getElementById('orderList');
  list.innerHTML = '';
  
  const isWaiter = document.body.classList.contains('waiter-active');
  const displayLang = isWaiter ? 'es' : lang;

  if(Object.keys(cart).length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.6">Tu lista est√° vac√≠a</div>`;
    if(!isWaiter) setTimeout(closeSheet, 1000); 
    return;
  }

  let items = Object.keys(cart).map(id => currentMenu.find(i => i.id == id)).filter(x=>x);
  const sortOrder = { 'bebidas': 1, 'entrantes': 2, 'principales': 3, 'postres': 4 };
  
  items.sort((a, b) => {
      return (sortOrder[a.cat] || 99) - (sortOrder[b.cat] || 99);
  });

  items.forEach(p => {
    const qty = cart[p.id];
    const pName = p.name[displayLang] || p.name['es']; 
    
    let emojisHTML = '';
    if (p.emojis && p.emojis.trim() !== '') {
        emojisHTML = `<span class="allergy-badge" style="font-size:0.75rem">${p.emojis}</span>`;
    }
    
    if(isWaiter) {
      list.innerHTML += `
        <div class="order-item">
          <div style="display:flex; align-items:flex-start">
             <span class="qty-display">${qty}x</span>
             <span class="order-name">${pName} ${emojisHTML}</span>
          </div>
        </div>`;
    } else {
      list.innerHTML += `
        <div class="order-item">
          <span class="order-name" style="flex:1">${pName} ${emojisHTML}</span>
          <div class="qty-selector" style="width:100px;">
            <button onclick="remove(${p.id})">-</button><span>${qty}</span><button class="plus" onclick="add(${p.id})">+</button>
          </div>
        </div>`;
    }
  });
}

async function enterWaiterMode() {
  document.body.classList.add('waiter-active');
  document.getElementById('orderSheet').classList.add('waiter-mode');
  
  document.getElementById('btnShowWaiter').style.display = 'none';
  document.getElementById('notesArea').style.display = 'none';
  document.getElementById('clearTxt').style.display = 'none';
  document.getElementById('userCloseBtn').style.display = 'none'; 
  document.getElementById('modalTitle').style.display = 'none';
  document.getElementById('closeWaiterBtn').style.display = 'flex'; 
  
  const notes = document.getElementById('notesField').value;
  const waiterNotesDisplay = document.getElementById('waiterNotesDisplay');
  
  if (notes && notes.trim() !== "") {
    waiterNotesDisplay.style.display = 'block';
    waiterNotesDisplay.innerHTML = `<div class="waiter-note-box">Traducido comentario... ‚è≥</div>`;
    
    try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(notes)}&langpair=${lang}|es`);
        const data = await res.json();
        let translatedText = notes;
        if (data.responseData && data.responseData.translatedText) {
            translatedText = data.responseData.translatedText;
        }
        waiterNotesDisplay.innerHTML = `
          <div class="waiter-note-box">
            <span class="waiter-note-label">üìù NOTA DEL CLIENTE:</span>
            "${translatedText}"
          </div>
        `;
    } catch (err) {
        waiterNotesDisplay.innerHTML = `<div class="waiter-note-box">"${notes}"</div>`;
    }
  } else {
    waiterNotesDisplay.style.display = 'none';
  }
  
  renderList(); 
}

function exitWaiterMode() {
  document.body.classList.remove('waiter-active');
  document.getElementById('orderSheet').classList.remove('waiter-mode');
  document.getElementById('closeWaiterBtn').style.display = 'none';
  document.getElementById('waiterNotesDisplay').style.display = 'none';
  document.getElementById('notesArea').style.display = 'block';
  document.getElementById('clearTxt').style.display = 'block';
  document.getElementById('userCloseBtn').style.display = 'block';
  document.getElementById('modalTitle').style.display = 'block';
  if(lang !== 'es') document.getElementById('btnShowWaiter').style.display = 'flex';
  renderList();
}

function saveCart() { try { localStorage.setItem('demo_cart', JSON.stringify(cart)); } catch(e){} }
function loadCart() { try { const s = localStorage.getItem('demo_cart'); if(s) cart = JSON.parse(s); } catch(e) {} }
function saveNotes() { try { localStorage.setItem('demo_notes', document.getElementById('notesField').value); } catch(e){} }
function clearCart() { cart={}; saveCart(); render(); updateFloat(); closeSheet(); }

function translateUI() {
  const t = uiDict[lang] || uiDict['es'];
  document.getElementById('brandNameDisplay').innerText = t.pageTitle;
  
  document.getElementById('f-ent').innerText = t.ent;
  document.getElementById('f-main').innerText = t.main;
  document.getElementById('f-des').innerText = t.des;
  document.getElementById('f-drk').innerText = t.drk;
  document.getElementById('btnText').innerText = t.btn;
  document.getElementById('modalTitle').innerText = t.title;
  document.getElementById('clearTxt').innerText = t.clear;
  document.getElementById('notesField').placeholder = t.place;
  
  document.getElementById('opt-all').innerText = t.all;
  document.getElementById('opt-gf').innerText = t.gf;
  document.getElementById('opt-lf').innerText = t.lf;
  document.getElementById('opt-nuts').innerText = t.nuts;
  
  const waiterSpan = document.getElementById('btnWaiterText');
  if(waiterSpan) waiterSpan.innerText = "üó£Ô∏è " + t.trans;
}

const themeBtn = document.getElementById('themeBtn');
function applyTheme() {
  let saved = 'light';
  try { saved = localStorage.getItem('theme') || 'light'; } catch(e){}
  document.documentElement.setAttribute('data-theme', saved);
  themeBtn.innerHTML = saved === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}
themeBtn.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  try { localStorage.setItem('theme', next); } catch(e){}
  applyTheme();
});

init();
</script>
</body>
</html>