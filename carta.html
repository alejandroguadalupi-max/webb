<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=1" />
<title>Mi Lista de Pedido</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  /* --- Paleta PataMig --- */
  --bg-body: #fdfdfd;
  --bg-card: #ffffff;
  --text-main: #2d3436;
  --text-sec: #636e72;
  --primary: #68B553; 
  --primary-dark: #509e3c;
  --primary-light: #eafbe4;
  --shadow-card: 0 8px 30px rgba(0,0,0,0.04);
  --shadow-float: 0 15px 35px rgba(104, 181, 83, 0.25);
  --border: #f1f2f6;
  --radius: 20px;
  --font: 'Plus Jakarta Sans', sans-serif;
  --spanish-btn: #FFC107; 
}

[data-theme="dark"] {
  --bg-body: #0f0f0f;
  --bg-card: #1a1a1a;
  --text-main: #f5f6fa;
  --text-sec: #a4b0be;
  --primary: #68B553;
  --primary-dark: #68B553;
  --primary-light: rgba(104, 181, 83, 0.15);
  --shadow-card: 0 8px 30px rgba(0,0,0,0.3);
  --border: #2f3640;
  --spanish-btn: #FFD54F;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; background: var(--bg-body); color: var(--text-main); font-family: var(--font);
  transition: background 0.3s ease; padding-bottom: 120px;
}

/* Header */
.header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(var(--bg-card), 0.95); backdrop-filter: blur(12px);
  padding: 12px 20px; 
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border);
}
.header-left .brand { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; color: var(--primary); margin: 0; }
.header-right { display: flex; align-items: center; gap: 8px; }

/* Selector Alergias */
.allergy-select {
  appearance: none; -webkit-appearance: none;
  background: var(--bg-body); border: 1px solid var(--border);
  color: var(--text-main); font-family: inherit; font-size: 0.75rem; font-weight: 700;
  padding: 8px 12px; border-radius: 50px;
  cursor: pointer; outline: none; text-align: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 130px;
}

/* Botones Header */
.lang-btn { font-size: 0.75rem; font-weight: 800; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-sec); padding: 8px 10px; border-radius: 50px; cursor: default; }
.theme-btn { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-main); display: flex; align-items: center; }
.visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }

.info-bar { padding: 10px 24px; background: var(--primary-light); color: var(--primary-dark); font-size: 0.85rem; font-weight: 600; text-align: center; }

/* Filtros */
.filters-wrap {
  position: sticky; top: 65px; z-index: 90; padding: 12px 0; margin-bottom: 10px;
  background: linear-gradient(to bottom, var(--bg-body) 85%, transparent);
}
.filters-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 24px; scrollbar-width: none; }
.filters-scroll::-webkit-scrollbar { display: none; }
.filter-pill {
  padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 50px; 
  white-space: nowrap; font-size: 0.9rem; font-weight: 600; color: var(--text-sec); cursor: pointer; transition: 0.2s;
  box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.filter-pill.active { color: white; background: var(--primary); border-color: var(--primary); box-shadow: 0 4px 15px var(--primary-light); }

/* Grid Platos */
.menu-grid { display: flex; flex-direction: column; gap: 16px; padding: 0 20px; max-width: 800px; margin: 0 auto; }
.dish-card {
  background: var(--bg-card); border-radius: var(--radius); padding: 16px;
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
  box-shadow: var(--shadow-card); border: 1px solid var(--border); transition: 0.2s;
}
.dish-card:active { transform: scale(0.98); }
.dish-info { flex: 1; }
.dish-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
.dish-name { font-weight: 700; font-size: 1.05rem; line-height: 1.3; }
.dish-desc { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
.dish-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; min-width: 75px; }
.dish-price { font-weight: 700; font-size: 1rem; color: var(--primary-dark); }
.add-btn {
  background: var(--primary-light); color: var(--primary-dark); border: none; height: 36px; padding: 0 16px; 
  border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.3s;
}
.add-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-light); }

/* Float Button */
#cart-float {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px) scale(0.9);
  background: var(--text-main); color: var(--bg-card); 
  padding: 16px 28px; border-radius: 100px; 
  display: flex; align-items: center; gap: 16px; justify-content: center;
  box-shadow: var(--shadow-float); cursor: pointer; z-index: 1000; transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-weight: 700; font-size: 1rem;
}
#cart-float.visible { transform: translateX(-50%) translateY(0) scale(1); }
.badge-count { background: var(--primary); color: white; padding: 2px 8px; border-radius: 50px; font-size: 0.8rem; font-weight: 800; }

/* MODAL / SHEET */
.overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
  z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; justify-content: center; align-items: flex-end;
}
.overlay.open { opacity: 1; pointer-events: auto; }
.sheet {
  background: var(--bg-card); width: 100%; max-width: 600px; max-height: 90vh; border-radius: 32px 32px 0 0;
  padding: 24px; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
  box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
}
.overlay.open .sheet { transform: translateY(0); }

/* MODO CAMARERO (PANTALLA COMPLETA) */
.sheet.waiter-mode {
  height: 100% !important; max-height: 100vh !important;
  border-radius: 0; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
  transform: translateY(0); z-index: 3000; padding-top: 80px;
}
.sheet.waiter-mode .sheet-header, 
.sheet.waiter-mode .notes-container #waiterMsg, 
.sheet.waiter-mode .clear-btn, 
.sheet.waiter-mode .qty-controls { display: none !important; }

/* Estilo items en modo camarero */
.sheet.waiter-mode .order-item { border-bottom: 2px solid var(--border); padding: 25px 20px; justify-content: flex-start; }
.sheet.waiter-mode .order-item div { font-size: 1.6rem !important; font-weight: 800 !important; color: var(--text-main); }
.sheet.waiter-mode .waiter-qty { display: block !important; font-size: 2rem !important; font-weight: 900; color: var(--primary); margin-right: 20px; }
.sheet.waiter-mode textarea.notes { font-size: 1.4rem; font-weight: 700; color: #000; background-color: var(--spanish-btn); border-color: var(--spanish-btn); }

/* Bot√≥n cerrar modo camarero */
#closeWaiterBtn {
  display: none; position: absolute; top: 25px; right: 25px; z-index: 3001;
  background: rgba(0,0,0,0.8); color: white;
  border: none; padding: 12px 24px; border-radius: 50px;
  font-weight: 700; font-size: 1rem; cursor: pointer;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

.sheet-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed var(--border); }
.header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }

.waiter-controls { display: flex; gap: 10px; width: 100%; }
.translate-btn {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 14px; border-radius: 14px; background: var(--bg-body); border: 1px solid var(--border);
  font-weight: 700; font-size: 0.95rem; cursor: pointer; color: var(--text-sec); transition: 0.2s;
}
.translate-btn.active { background: var(--spanish-btn); color: black; border-color: var(--spanish-btn); box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2); }

.order-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.order-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-body); border-radius: 16px; }
.qty-controls { display: flex; align-items: center; gap: 12px; }
.qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-main); font-weight: 700; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

.waiter-qty { display: none; }
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-sec); }
.empty-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }
.empty-text { font-size: 0.95rem; line-height: 1.6; }

.notes-container { margin-top: auto; }
textarea.notes {
  width: 100%; padding: 16px; border-radius: 16px; background: var(--bg-body); border: 2px solid var(--border);
  color: var(--text-main); font-family: inherit; resize: none; outline: none; font-size: 0.95rem; margin-bottom: 10px; transition: 0.3s;
}
textarea.notes:focus { border-color: var(--primary); }
.clear-btn { margin-top:15px; width: 100%; background:none; border:none; color:var(--text-sec); text-decoration:underline; cursor:pointer; font-size:0.9rem; opacity: 0.7;}
</style>
</head>
<body id="bodyTag">

<header class="header">
  <div class="header-left">
    <h1 class="brand">Carta</h1>
  </div>
  <div class="header-right">
    <select id="allergyFilter" class="allergy-select" onchange="applyAllergyFilter()">
      <option value="">ALERGIAS ‚ñæ</option>
      <option value="gf">üåæ Sin Gluten</option>
      <option value="lf">ü•õ Sin Lactosa</option>
      <option value="v">üå± Vegano</option>
    </select>
    <div class="lang-badge" id="langDisplay">ES</div>
    <button class="theme-btn" id="themeBtn"></button>
  </div>
</header>

<div class="info-bar" data-lang="infoBar">
  üìù A√±ade platos aqu√≠ para dictarlos luego.
</div>

<div class="filters-wrap">
  <div class="filters-scroll">
    <button class="filter-pill active" onclick="filter('bebidas')" id="f-drk">Bebidas</button>
    <button class="filter-pill" onclick="filter('entrantes')" id="f-ent">Entrantes</button>
    <button class="filter-pill" onclick="filter('principales')" id="f-main">Principales</button>
    <button class="filter-pill" onclick="filter('postres')" id="f-des">Postres</button>
  </div>
</div>

<div class="menu-grid" id="menuContainer"></div>

<div id="cart-float" onclick="openSheet()">
  <span class="badge-count" id="countBadge">0</span>
  <span id="btnText">Ver mi Lista</span>
</div>

<div class="overlay" id="overlay" onclick="if(event.target===this) closeSheet()">
  
  <button id="closeWaiterBtn" onclick="exitWaiterMode()">‚úï Cerrar Vista Camarero</button>

  <div class="sheet" id="orderSheet">
    <div class="sheet-header">
      <div class="header-top">
        <h3 style="margin:0; font-size:1.5rem; letter-spacing:-0.5px" id="modalTitle">Tu Lista</h3>
        <div onclick="closeSheet()" style="cursor:pointer; padding:8px; opacity:0.5; font-size:1.5rem">√ó</div>
      </div>
      
      <div class="waiter-controls" id="waiterControls">
        <button id="translateBtn" class="translate-btn" onclick="enterWaiterMode()">
          <span>üá™üá∏</span> <span id="transText">Mostrar al Camarero (ES)</span>
        </button>
      </div>
    </div>
    
    <div class="order-list" id="orderList"></div>

    <div class="notes-container">
      <textarea class="notes" id="notesField" placeholder="Notas..." oninput="saveNotes()"></textarea>
      <div style="text-align:center; font-size:0.85rem; color:var(--text-sec); font-weight:500" id="waiterMsg">üí° Lee esto al camarero.</div>
    </div>
    
    <button onclick="clearCart()" class="clear-btn" id="clearTxt">Borrar lista</button>
  </div>
</div>

<script>
/* --- DICCIONARIO --- */
const i18n = {
  es: { ent: "Entrantes", main: "Principales", des: "Postres", drk: "Bebidas", btn: "Ver mi Lista", title: "Tu Lista", msg: "üí° Lee esta lista al camarero/a.", clear: "Borrar todo", empty: "Tu lista est√° vac√≠a.", ph: "Notas (ej. sin hielo...)", trans: "Modo Camarero", infoBar: "üìù Ve a√±adiendo platos a tu lista." },
  en: { ent: "Starters", main: "Mains", des: "Desserts", drk: "Drinks", btn: "View my List", title: "Your List", msg: "üí° Read this list to the waiter.", clear: "Clear all", empty: "Your list is empty.", ph: "Notes (e.g. no ice...)", trans: "Show Waiter (ES)", infoBar: "üìù Add dishes here to prepare your order." },
  de: { ent: "Vorspeisen", main: "Hauptspeisen", des: "Desserts", drk: "Getr√§nke", btn: "Meine Liste", title: "Deine Liste", msg: "üí° Dem Kellner vorlesen.", clear: "L√∂schen", empty: "Deine Liste ist leer.", ph: "Notizen...", trans: "Dem Kellner zeigen (ES)", infoBar: "üìù F√ºge hier Gerichte hinzu." },
  fr: { ent: "Entr√©es", main: "Plats", des: "Desserts", drk: "Boissons", btn: "Ma Liste", title: "Votre Liste", msg: "üí° Lire au serveur.", clear: "Effacer", empty: "Votre liste est vide.", ph: "Notes...", trans: "Montrer au serveur (ES)", infoBar: "üìù Ajoutez des plats ici." },
  it: { ent: "Antipasti", main: "Primi/Secondi", des: "Dolci", drk: "Bevande", btn: "La mia Lista", title: "La tua Lista", msg: "üí° Leggi al cameriere.", clear: "Cancella", empty: "La tua lista √® vuota.", ph: "Note...", trans: "Mostra al cameriere (ES)", infoBar: "üìù Aggiungi qui i piatti." }
};

/* --- DATOS --- */
const menu = [
  { id: 201, tags: ['gf','lf','v'], cat: 'bebidas', price: 2.50, name: { es: "Coca-Cola", en: "Coca-Cola", de: "Coca-Cola", fr: "Coca-Cola", it: "Coca-Cola" }, desc: { es: "33cl", en: "33cl", de: "33cl", fr: "33cl", it: "33cl" } },
  { id: 202, tags: ['gf','lf','v'], cat: 'bebidas', price: 2.50, name: { es: "Coca-Cola Zero", en: "Coke Zero", de: "Cola Zero", fr: "Coca Z√©ro", it: "Coca Zero" }, desc: { es: "33cl", en: "33cl", de: "33cl", fr: "33cl", it: "33cl" } },
  { id: 203, tags: ['gf','lf','v'], cat: 'bebidas', price: 2.50, name: { es: "Fanta Naranja", en: "Fanta Orange", de: "Fanta Orange", fr: "Fanta Orange", it: "Fanta Arancia" }, desc: { es: "33cl", en: "33cl", de: "33cl", fr: "33cl", it: "33cl" } },
  { id: 204, tags: ['gf','lf','v'], cat: 'bebidas', price: 2.50, name: { es: "Fanta Lim√≥n", en: "Fanta Lemon", de: "Fanta Zitrone", fr: "Fanta Citron", it: "Fanta Limone" }, desc: { es: "33cl", en: "33cl", de: "33cl", fr: "33cl", it: "33cl" } },
  { id: 207, tags: ['gf','lf','v'], cat: 'bebidas', price: 2.00, name: { es: "Agua", en: "Water", de: "Wasser", fr: "Eau", it: "Acqua" }, desc: { es: "50cl", en: "50cl", de: "50cl", fr: "50cl", it: "50cl" } },
  { id: 1, tags: ['gf','lf'], cat: 'entrantes', price: 9.50, name: { es: "Huevos Rotos", en: "Broken Eggs", de: "Zerbrochene Eier", fr: "≈íufs cass√©s", it: "Uova rotte" }, desc: { es: "Con jam√≥n ib√©rico.", en: "With Iberian ham.", de: "Mit iberischem Schinken.", fr: "Au jambon ib√©rique.", it: "Con prosciutto iberico." } },
  { id: 2, tags: [], cat: 'entrantes', price: 6.50, name: { es: "Croquetas (4ud)", en: "Croquettes (4pcs)", de: "Kroketten (4 Stk)", fr: "Croquettes (4pcs)", it: "Crocchette (4pz)" }, desc: { es: "Boletus y Trufa.", en: "Boletus & Truffle.", de: "Steinpilz & Tr√ºffel.", fr: "C√®pes et Truffe.", it: "Porcini e Tartufo." } },
  { id: 3, tags: ['gf','lf'], cat: 'principales', price: 16.00, name: { es: "Entrecot Vaca", en: "Beef Entrecote", de: "Rinderentrecote", fr: "Entrec√¥te de b≈ìuf", it: "Entrecote di manzo" }, desc: { es: "300g a la parrilla.", en: "300g grilled.", de: "300g gegrillt.", fr: "300g grill√©.", it: "300g alla griglia." } },
  { id: 4, tags: [], cat: 'principales', price: 12.50, name: { es: "Burger Premium", en: "Premium Burger", de: "Premium Burger", fr: "Burger Premium", it: "Burger Premium" }, desc: { es: "Queso de cabra y cebolla.", en: "Goat cheese & onion.", de: "Ziegenk√§se & Zwiebel.", fr: "Ch√®vre et oignon.", it: "Formaggio di capra e cipolla." } },
  { id: 5, tags: ['v'], cat: 'postres', price: 6.00, name: { es: "Coulant Choco", en: "Choco Coulant", de: "Schoko-Coulant", fr: "Coulant au chocolat", it: "Coulant al cioccolato" }, desc: { es: "Con helado.", en: "With ice cream.", de: "Mit Eis.", fr: "Avec glace.", it: "Con gelato." } }
];

/* --- ESTADO --- */
let cart = {};
let filterCat = 'bebidas';
let lang = 'es';
let waiterMode = false; 
let originalNote = ""; 
let currentAllergy = ""; 

function loadCart() {
  const saved = localStorage.getItem('pataMig_cart');
  if(saved) cart = JSON.parse(saved) || {}; // Evita error si es null
  const savedNotes = localStorage.getItem('pataMig_notes');
  if(savedNotes) document.getElementById('notesField').value = savedNotes;
}
function saveCart() { localStorage.setItem('pataMig_cart', JSON.stringify(cart)); }
function saveNotes() { localStorage.setItem('pataMig_notes', document.getElementById('notesField').value); }

/* --- LOGICA INICIAL --- */
function init() {
  const urlP = new URLSearchParams(window.location.search).get('lang');
  const saved = localStorage.getItem('userLang');
  const browser = navigator.language.slice(0,2);
  
  if(urlP && i18n[urlP]) lang = urlP;
  else if(saved && i18n[saved]) lang = saved;
  else if(i18n[browser]) lang = browser;
  
  localStorage.setItem('userLang', lang);
  document.getElementById('langDisplay').innerText = lang.toUpperCase();
  
  loadCart(); 
  render();
  updateFloat(); 
}

/* --- FILTROS --- */
function applyAllergyFilter() {
  currentAllergy = document.getElementById('allergyFilter').value;
  render(); 
}

function render() {
  const list = document.getElementById('menuContainer');
  list.innerHTML = '';
  const txt = i18n[lang];

  document.getElementById('f-ent').innerText = txt.ent;
  document.getElementById('f-main').innerText = txt.main;
  document.getElementById('f-des').innerText = txt.des;
  document.getElementById('f-drk').innerText = txt.drk;
  document.getElementById('btnText').innerText = txt.btn;
  document.getElementById('modalTitle').innerText = txt.title;
  document.getElementById('waiterMsg').innerText = txt.msg;
  document.getElementById('clearTxt').innerHTML = txt.clear;
  document.getElementById('notesField').placeholder = txt.ph;
  document.getElementById('transText').innerText = txt.trans;
  document.querySelector('[data-lang="infoBar"]').innerHTML = txt.infoBar;

  const wControls = document.getElementById('waiterControls');
  if (lang === 'es') wControls.style.display = 'none';
  else wControls.style.display = 'flex';

  menu.forEach(p => {
    if(p.cat !== filterCat) return;
    if(currentAllergy !== "" && !p.tags.includes(currentAllergy)) return;

    const qty = cart[p.id] || 0;
    let btnTxt = '+';
    let btnClass = 'add-btn';
    if(qty > 0) { btnTxt = `${qty} +`; btnClass += ' active'; }

    list.innerHTML += `
      <div class="dish-card">
        <div class="dish-info">
          <div class="dish-header"><span class="dish-name">${p.name[lang]}</span></div>
          <div class="dish-desc">${p.desc[lang]}</div>
        </div>
        <div class="dish-actions">
          <span class="dish-price">${p.price.toFixed(2)}‚Ç¨</span>
          <button class="${btnClass}" onclick="add(${p.id})">${btnTxt}</button>
        </div>
      </div>
    `;
  });
}

function add(id) { cart[id] = (cart[id] || 0) + 1; saveCart(); render(); updateFloat(); if(document.getElementById('overlay').classList.contains('open')) renderList(); }
function remove(id) { if(cart[id]) { cart[id]--; if(cart[id] <= 0) delete cart[id]; } saveCart(); render(); updateFloat(); renderList(); }

function updateFloat() {
  const count = Object.values(cart).reduce((a,b)=>a+b,0);
  document.getElementById('countBadge').innerText = count;
  const btn = document.getElementById('cart-float');
  if(count > 0) btn.classList.add('visible'); else btn.classList.remove('visible');
}

/* --- TRADUCCI√ìN API (MyMemory) --- */
async function fetchTranslation(text, sourceLang) {
  if (!text || sourceLang === 'es') return text;
  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|es`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.responseStatus === 200) return data.responseData.translatedText;
    else return text;
  } catch (error) {
    console.error("Error al traducir:", error);
    return text;
  }
}

/* --- MODO CAMARERO (ASYNC) --- */
async function enterWaiterMode() {
  waiterMode = true;
  const sheet = document.getElementById('orderSheet');
  const closeBtn = document.getElementById('closeWaiterBtn');
  const noteField = document.getElementById('notesField');

  // 1. Mostrar estado de carga si hay nota
  const textToTranslate = noteField.value;
  if(textToTranslate && lang !== 'es') {
    noteField.value = "Traducere... / Translating... ‚è≥";
  }

  // 2. Activar pantalla completa
  sheet.classList.add('waiter-mode');
  closeBtn.style.display = 'flex'; // Forzar display flex para el bot√≥n
  
  // 3. Traducir usando API
  originalNote = textToTranslate; // Guardar original
  
  if (originalNote.trim() !== "" && lang !== 'es') {
    const translatedText = await fetchTranslation(originalNote, lang);
    noteField.value = translatedText;
    noteField.style.borderColor = "var(--spanish-btn)";
    noteField.style.backgroundColor = "rgba(255, 193, 7, 0.2)"; // Fondo amarillo
  } else {
    noteField.value = originalNote;
  }
  
  renderList();
}

function exitWaiterMode() {
  waiterMode = false;
  document.getElementById('orderSheet').classList.remove('waiter-mode');
  document.getElementById('closeWaiterBtn').style.display = 'none';
  
  // Restaurar nota original
  const noteField = document.getElementById('notesField');
  if(originalNote !== "") noteField.value = originalNote;
  noteField.style.borderColor = "var(--border)";
  noteField.style.backgroundColor = "var(--bg-body)";
  
  renderList();
}

function renderList() {
  const cont = document.getElementById('orderList');
  cont.innerHTML = '';
  // Si modo camarero, forzar espa√±ol. Si no, idioma usuario.
  const displayLang = waiterMode ? 'es' : lang; 

  if(Object.keys(cart).length === 0) {
    cont.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">${i18n[lang].empty}</div></div>`;
  } else {
    Object.keys(cart).forEach(id => {
      const p = menu.find(x => x.id == id);
      if(!p) return; 
      const qty = cart[id];
      
      cont.innerHTML += `
        <div class="order-item">
          <div class="waiter-qty">x${qty}</div>
          
          <div style="flex:1">
            <div style="font-weight:700; font-size:1.1rem; transition:0.3s">${p.name[displayLang]}</div>
          </div>
          
          <div class="qty-controls">
            <button class="qty-btn" onclick="remove(${id})">-</button>
            <span style="font-weight:700; width:25px; text-align:center">${qty}</span>
            <button class="qty-btn" onclick="add(${id})">+</button>
          </div>
        </div>
      `;
    });
  }
}

function filter(cat) {
  filterCat = cat;
  document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
  let id='f-drk';
  if(cat==='entrantes') id='f-ent'; if(cat==='principales') id='f-main'; if(cat==='postres') id='f-des';
  document.getElementById(id).classList.add('active');
  render();
}

function clearCart() {
  if(confirm(i18n[lang].clear + '?')) {
    cart = {}; document.getElementById('notesField').value = '';
    saveCart(); saveNotes(); exitWaiterMode();
    render(); updateFloat(); closeSheet();
  }
}

function openSheet() { 
  exitWaiterMode(); // Resetear siempre al abrir
  renderList(); 
  document.getElementById('overlay').classList.add('open'); 
}
function closeSheet() { 
  exitWaiterMode();
  document.getElementById('overlay').classList.remove('open'); 
}

/* --- THEME --- */
const themeBtn = document.getElementById('themeBtn');
function applyTheme() {
  let savedTheme = localStorage.getItem('theme');
  if (!savedTheme) savedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  themeBtn.innerHTML = savedTheme === 'dark'
    ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
    : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
}
themeBtn.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  localStorage.setItem('theme', newTheme);
  applyTheme();
});

// Init
applyTheme();
init();
</script>
</body>
</html>