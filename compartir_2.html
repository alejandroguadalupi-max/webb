<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#68B553" />
<title data-lang="title">Compartir experiencia ¬∑ PataMig</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary-green: #68B553;
  --bg-light-green: #E8F5E1; 
  --text-dark: #333;
  --muted: #6b7280;
  --border: #d0e2c8;
  --white: #fff;
  --shadow-light: rgba(0,0,0,0.08);
  --shadow-medium: rgba(0,0,0,0.12);
}

*, *::before, *::after { box-sizing: border-box; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes zoomIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif; 
  background: var(--bg-light-green);
  color: var(--text-dark);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.wrap {
  width: 100%;
  max-width: 450px; 
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: fadeIn 0.5s ease-out; 
}

/* 3. Bot√≥n de Volver ELIMINADO */

.share-card {
  background: var(--white);
  border-radius: 20px; 
  padding: 30px; 
  border: 1px solid var(--border);
  width: 100%;
  text-align: center;
  box-shadow: 0 10px 30px var(--shadow-light); 
}

h2 {
  margin: 0 0 10px;
  font-size: 1.6em; 
  font-weight: 700;
  color: var(--text-dark);
}

p.subtitle { /* Clase a√±adida para el subt√≠tulo */
  margin: 0 0 20px;
  font-size: 0.95em; 
  color: var(--muted);
  line-height: 1.5;
}

/* --- 1. NUEVO DISE√ëO DE FOTO --- */
.photo-area {
  width: 100%;
  aspect-ratio: 4/3;
  border-radius: 16px; 
  border: 2px dashed var(--border); /* Borde discontinuo para "placeholder" */
  background: #fdfdfd; 
  overflow: hidden; /* Clave para el bot√≥n de eliminar */
  display: flex; 
  align-items: center;
  justify-content: center;
  margin-bottom: 20px; 
  position: relative; /* Clave para el bot√≥n de eliminar */
  transition: border-color 0.2s ease;
}

.photo-area:hover {
  border-color: var(--primary-green);
}

/* Contenedor de la vista previa de la foto */
.photo-preview-container {
  width: 100%;
  height: 100%;
  display: none; /* Oculto por defecto */
}

.photo-preview {
  width: 100%;
  height: 100%;
  object-fit: cover; 
}

/* Bot√≥n para eliminar la foto */
#btnRemovePhoto {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 30px;
  height: 30px;
  border: none;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: white;
  font-size: 1.2em;
  font-weight: 700;
  line-height: 30px;
  text-align: center;
  cursor: pointer;
  z-index: 5;
  transition: background 0.2s ease, transform 0.2s ease;
  display: none; /* Oculto por defecto */
}
#btnRemovePhoto:hover {
  background: rgba(0,0,0,0.8);
  transform: scale(1.1);
}

/* Contenido del placeholder (botones C√°mara/Galer√≠a) */
.placeholder-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 15px;
  padding: 20px;
  animation: zoomIn 0.3s ease-out;
}

.placeholder-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 200px;
  padding: 12px 0;
  border: 2px solid var(--primary-green);
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.0em;
  cursor: pointer;
  transition: all 0.25s ease;
  color: var(--primary-green);
  background: var(--white);
}
.placeholder-btn:hover {
  background: var(--primary-green);
  color: var(--white);
  transform: scale(1.05);
}
.placeholder-btn span {
  font-size: 1.5em; /* Icono grande */
  line-height: 1;
}
/* --- FIN NUEVO DISE√ëO DE FOTO --- */


/* 1. Botones de fila ELIMINADOS */
.row { display: none; }

.btn {
  padding: 14px 0; 
  border: none;
  border-radius: 12px; 
  font-weight: 600;
  font-size: 1.0em;
  cursor: pointer;
  transition: all 0.25s ease;
  will-change: transform, box-shadow;
}

.btn-green {
  background: var(--primary-green);
  color: var(--white);
  box-shadow: 0 6px 20px rgba(104,181,83,0.25);
}
.btn-green:hover { 
  background: #5ca54a; 
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(104,181,83,0.35);
}

.watermark-toggle {
  margin: 10px 0 20px; 
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
  color: var(--muted);
  justify-content: center;
  cursor: pointer; 
}

.watermark-toggle input[type="checkbox"] {
  transform: scale(1.2); 
  accent-color: var(--primary-green); 
}

.note {
  font-size: 0.85em; 
  color: var(--muted);
  margin-top: 10px;
}

/* 3. Selector de Idioma ELIMINADO */
#lang-selector { display: none; }

/* Popup de √âxito (sin cambios) */
.success-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  animation: fadeIn 0.3s ease-out;
}
.success-box {
  background: var(--white);
  padding: 30px 40px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 10px 40px var(--shadow-medium);
  transform: scale(0.9);
  animation: successScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes successScale {
  to { transform: scale(1); }
}
.success-box h3 { color: var(--primary-green); margin: 0 0 8px; font-size: 1.5em; font-weight: 700; }
.success-box p { color: var(--muted); font-size: 1em; margin: 0; }

</style>
</head>
<body>

<div class="wrap">
  <div class="share-card">
    <h2 id="shareTitle">üì∏ Comparte tu momento</h2>
    <p id="shareSub" class="subtitle">Elige o toma una foto y comp√°rtela con tus amigos.</p>

    <div class="photo-area" id="photoArea">
      
      <div class="photo-preview-container" id="photoPreviewContainer">
        <img id="photoPreview" class="photo-preview" alt="Vista previa">
      </div>
      
      <button id="btnRemovePhoto">√ó</button>

      <div class="placeholder-content" id="placeholderContent">
        <div class="placeholder-btn" id="btnCamera">
          <span>üì∑</span> <span data-lang="takePhoto">Tomar foto</span>
        </div>
        <div class="placeholder-btn" id="btnGallery">
          <span>üñºÔ∏è</span> <span data-lang="choosePhoto">Elegir foto</span>
        </div>
      </div>

    </div>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
    <input type="file" id="galleryInput" accept="image/*" style="display:none;">

    <label class="watermark-toggle">
      <input type="checkbox" id="chkWatermark" checked>
      <span id="watermarkLabel">Incluir nombre del restaurante</span>
    </label>

    <button id="btnShare" class="btn btn-green" style="width:100%;">Compartir</button>
    <p class="note" id="note">Si no eliges foto, se compartir√° una tarjeta del restaurante.</p>
  </div>
</div>

<script>
const DEFAULT_CARD="img/logo35.png"; 
const LOGO_WATERMARK_URL = "img/PataMig.png"; 
const COPY={
¬†es:{title:"Compartir experiencia ¬∑ PataMig",shareTitle:"üì∏ Comparte tu momento",shareSub:"Elige o toma una foto y comp√°rtela con tus amigos.",note:"Si no eliges foto, se compartir√° una tarjeta del restaurante.",shareBtn:"Compartir",takePhoto:"Tomar foto",choosePhoto:"Elegir foto",watermark:"Incluir nombre del restaurante",success:"‚úÖ Compartido con √©xito", redirecting:"Redirigiendo..."},
¬†en:{title:"Share Experience ¬∑ PataMig",shareTitle:"üì∏ Share your moment",shareSub:"Take or choose a photo and share with friends.",note:"If you don't choose a photo, a restaurant card will be shared.",shareBtn:"Share",takePhoto:"Take photo",choosePhoto:"Choose photo",watermark:"Include restaurant name",success:"‚úÖ Shared successfully", redirecting:"Redirecting..."}
};

// --- 3. DETECCI√ìN DE IDIOMA POR URL ---
const urlParams = new URLSearchParams(window.location.search);
let initialLang = urlParams.get("lang") || "es";
if (!COPY[initialLang]) initialLang = "es";
let currentLang = initialLang;
// --- FIN DETECCI√ìN DE IDIOMA ---

const cameraInput=document.getElementById('cameraInput');
const galleryInput=document.getElementById('galleryInput');

// --- 1. NUEVOS ELEMENTOS DE FOTO ---
const photoArea = document.getElementById('photoArea');
const photoPreviewContainer = document.getElementById('photoPreviewContainer');
const photoPreview = document.getElementById('photoPreview');
const placeholderContent = document.getElementById('placeholderContent');
const btnCamera = document.getElementById('btnCamera');
const btnGallery = document.getElementById('btnGallery');
const btnRemovePhoto = document.getElementById('btnRemovePhoto');
// --- FIN NUEVOS ELEMENTOS ---

const btnShare=document.getElementById('btnShare');
const noteEl=document.getElementById('note');
const chkWatermark=document.getElementById('chkWatermark');
const watermarkLabel=document.getElementById('watermarkLabel');

// 3. Bot√≥n Volver y Selector de Idioma ELIMINADOS
// const backBtn=document.getElementById('backBtn');
// const currentLangDiv=document.getElementById('current-lang');
// const optionsDiv=document.getElementById('lang-options');

function setLang(lang){
¬† const c=COPY[lang];
  if (!c) return; // Salir si el idioma no existe

¬† document.title=c.title;
¬† document.getElementById('shareTitle').textContent=c.shareTitle;
¬† document.getElementById('shareSub').textContent=c.shareSub;
¬† btnShare.textContent=c.shareBtn;
¬† noteEl.textContent=c.note;
¬† // 1. Asegurarse de que los botones del placeholder se traducen
  // (query inside setLang in case elements are not yet found on script start)
  document.querySelector('[data-lang="takePhoto"]').textContent = c.takePhoto;
  document.querySelector('[data-lang="choosePhoto"]').textContent = c.choosePhoto;
¬† watermarkLabel.textContent=c.watermark;
¬† currentLang = lang; 
}

// 3. initLangSelector() ELIMINADO

// 1. Nuevos OnClick para botones de placeholder
btnCamera.onclick=()=>cameraInput.click();
btnGallery.onclick=()=>galleryInput.click();

let selectedFile=null;
function handleFileInput(input){
¬† const f=input.files?.[0];
¬† if(!f) return;
¬† selectedFile=f;
¬† photoPreview.src=URL.createObjectURL(f);
  
  // 1. Mostrar/Ocultar elementos
  placeholderContent.style.display = 'none';
  photoPreviewContainer.style.display = 'block';
  btnRemovePhoto.style.display = 'block';
  photoArea.style.borderColor = 'var(--primary-green)'; // Borde s√≥lido
  photoArea.style.borderStyle = 'solid';
}
cameraInput.onchange=()=>handleFileInput(cameraInput);
galleryInput.onchange=()=>handleFileInput(galleryInput);

// 1. L√≥gica del bot√≥n Eliminar Foto
btnRemovePhoto.onclick = () => {
  selectedFile = null;
  photoPreview.src = ''; // Limpiar la imagen
  cameraInput.value = null; // Resetear inputs
  galleryInput.value = null;

  // 1. Restaurar estado del placeholder
  placeholderContent.style.display = 'flex';
  photoPreviewContainer.style.display = 'none';
  btnRemovePhoto.style.display = 'none';
  photoArea.style.borderColor = 'var(--border)'; // Borde discontinuo
  photoArea.style.borderStyle = 'dashed';
};


// --- 2. MARCA DE AGUA (LOGO PEQUE√ëO EN ESQUINA) ---
async function addWatermarkToImage(file){
¬† return new Promise((resolve, reject)=>{
¬† ¬† const img = new Image();
¬† ¬† img.crossOrigin = "anonymous"; 
¬† ¬† img.src = URL.createObjectURL(file);

¬† ¬† img.onload = async () => {
¬† ¬† ¬† const canvas = document.createElement('canvas');
¬† ¬† ¬† const ctx = canvas.getContext('2d');
¬† ¬† ¬† canvas.width = img.width;
¬† ¬† ¬† canvas.height = img.height;
¬† ¬† ¬† ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

¬† ¬† ¬† const logo = new Image();
¬† ¬† ¬† logo.crossOrigin = "anonymous";
¬† ¬† ¬† logo.src = LOGO_WATERMARK_URL;

¬† ¬† ¬† logo.onload = () => {
¬† ¬† ¬† ¬† const logoNaturalWidth = logo.naturalWidth;
¬† ¬† ¬† ¬† const logoNaturalHeight = logo.naturalHeight;
¬† ¬† ¬† ¬†¬†
        // 2. Logo m√°s peque√±o (8% de altura, min 25px)
¬† ¬† ¬† ¬† const targetLogoHeight = Math.max(25, canvas.height * 0.08); 
¬† ¬† ¬† ¬† const targetLogoWidth = (logoNaturalWidth / logoNaturalHeight) * targetLogoHeight;
¬† ¬† ¬† ¬†¬†
        // 2. Margen m√°s peque√±o (3% de altura, min 15px)
¬† ¬† ¬† ¬† const margin = Math.max(15, canvas.height * 0.03); 
¬† ¬† ¬† ¬† const x = canvas.width - targetLogoWidth - margin;
¬† ¬† ¬† ¬† const y = canvas.height - targetLogoHeight - margin;

        // 2. Fondo semitransparente m√°s peque√±o
¬† ¬† ¬† ¬† ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; 
        const padding = 5; // Padding m√°s peque√±o
¬† ¬† ¬† ¬† ctx.roundRect(x - padding, y - padding, targetLogoWidth + (padding*2), targetLogoHeight + (padding*2), 5); // Radio de borde m√°s peque√±o
¬† ¬† ¬† ¬† ctx.fill();

¬† ¬† ¬† ¬† ctx.drawImage(logo, x, y, targetLogoWidth, targetLogoHeight);

¬† ¬† ¬† ¬† canvas.toBlob(b=>{
¬† ¬† ¬† ¬† ¬† resolve(new File([b],"patamig_momento.jpg",{type:"image/jpeg"}));
¬† ¬† ¬† ¬† },"image/jpeg",0.9);
¬† ¬† ¬† };
¬† ¬† ¬† logo.onerror = () => reject(new Error("Error al cargar el logo para la marca de agua."));
¬† ¬† };
¬† ¬† img.onerror = () => reject(new Error("Error al cargar la imagen seleccionada para la marca de agua."));
¬† });
}


function showSuccessMessage(){
¬† const popup=document.createElement('div');
¬† popup.className='success-popup';
¬† popup.innerHTML=`<div class="success-box"><h3>${COPY[currentLang].success}</h3><p>${COPY[currentLang].redirecting}</p></div>`;
¬† document.body.appendChild(popup);
¬† // 3. El redirect a principal.html no existe, lo cambio a la p√°gina de inicio
  // Asumir√© que es 'index.html' o la p√°gina anterior. 
  // Voy a usar history.back() para volver a la p√°gina que lo llam√≥.
¬† setTimeout(()=>{ 
    // Redirige a la p√°gina que ten√≠a el ?lang=es
    window.location.href = `index.html?lang=${currentLang}`;
  }, 2000);
}

async function shareExperience(e){
¬† e&&e.preventDefault();
¬† try{
¬† ¬† let baseFile;
¬† ¬† if(selectedFile){
¬† ¬† ¬† baseFile=selectedFile;
¬† ¬† } else {
¬† ¬† ¬† const res=await fetch(DEFAULT_CARD);
¬† ¬† ¬† const blob=await res.blob();
¬† ¬† ¬† baseFile=new File([blob],"patamig_card.jpg",{type:"image/jpeg"});
¬† ¬† }
¬† ¬† let fileToShare=baseFile;
¬† ¬† if(chkWatermark.checked){
¬† ¬† ¬† fileToShare=await addWatermarkToImage(baseFile);
¬† ¬† }

¬† ¬† if(navigator.canShare?.({files:[fileToShare]})){
¬† ¬† ¬† await navigator.share({
¬† ¬† ¬† ¬† files:[fileToShare],
¬† ¬† ¬† ¬† title: COPY[currentLang].shareTitle,
SO: ¬† ¬† ¬† ¬† text: COPY[currentLang].shareSub
¬† ¬† ¬† });
¬† ¬† ¬† showSuccessMessage();
¬† ¬† } else {
¬† ¬† ¬† const url=URL.createObjectURL(fileToShare);
¬† ¬† ¬† window.open(url,"_blank");
¬† ¬† ¬† showSuccessMessage(); 
¬† ¬† }
¬† }catch(err){ 
¬† ¬† if (err.name === 'AbortError') {
¬† ¬† ¬† ¬† console.log("Compartir cancelado por el usuario.");
¬† ¬† } else {
¬† ¬† ¬† ¬† console.error("Error al compartir:", err);
¬† ¬† }
¬† }
}

btnShare.onclick=shareExperience;

// 3. Aplicar el idioma detectado al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
  setLang(currentLang);

  // 1. Estado inicial del placeholder
  if (!selectedFile) {
    placeholderContent.style.display = 'flex';
    photoPreviewContainer.style.display = 'none';
    btnRemovePhoto.style.display = 'none';
  }
});
</script>
</body>
</html>
