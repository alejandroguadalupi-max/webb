<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#68B553" />
<title data-lang="title">Compartir experiencia Â· PataMig</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary-green: #68B553;
  --bg-light-green: #E8F5E1; /* Fondo muy suave para la pÃ¡gina */
  --text-dark: #333;
  --muted: #6b7280;
  --border: #d0e2c8;
  --white: #fff;
  --shadow-light: rgba(0,0,0,0.08);
  --shadow-medium: rgba(0,0,0,0.12);
}

*, *::before, *::after { box-sizing: border-box; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif; /* Usar Poppins */
  background: var(--bg-light-green);
  color: var(--text-dark);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.wrap {
  width: 100%;
  max-width: 450px; /* Ancho mÃ¡ximo un poco mÃ¡s grande */
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: fadeIn 0.5s ease-out; /* AnimaciÃ³n de entrada */
}

/* 1. BotÃ³n de Volver ahora un poco mÃ¡s discreto */
.back-button {
  position: absolute;
  top: 20px;
  left: 20px;
  background: var(--primary-green);
  color: var(--white);
  padding: 8px 14px;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
  font-size: 0.9em;
  box-shadow: 0 4px 10px rgba(104,181,83,0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.back-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(104,181,83,0.3);
}

.share-card {
  background: var(--white);
  border-radius: 20px; /* Bordes mÃ¡s redondeados */
  padding: 30px; /* Padding aumentado */
  border: 1px solid var(--border);
  width: 100%;
  text-align: center;
  box-shadow: 0 10px 30px var(--shadow-light); /* Sombra mÃ¡s suave */
}

h2 {
  margin: 0 0 10px;
  font-size: 1.6em; /* TÃ­tulo mÃ¡s grande */
  font-weight: 700;
  color: var(--text-dark);
}

p {
  margin: 0 0 18px;
  font-size: 0.95em; /* Texto mÃ¡s legible */
  color: var(--muted);
  line-height: 1.5;
}

.photo-container {
  width: 100%;
  aspect-ratio: 4/3;
  border-radius: 16px; /* Bordes mÃ¡s redondeados */
  border: 2px solid var(--border); /* Borde mÃ¡s visible */
  background: #fdfdfd; /* Fondo ligeramente mÃ¡s blanco */
  overflow: hidden;
  display: flex; /* Para centrar la imagen */
  align-items: center;
  justify-content: center;
  margin-bottom: 20px; /* MÃ¡s espacio */
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Sombra interna sutil */
}

.photo-preview {
  width: 100%;
  height: 100%;
  object-fit: cover; /* Recortar si es necesario para llenar el contenedor */
}

.row {
  display: flex;
  gap: 12px; /* MÃ¡s espacio entre botones */
  justify-content: center;
  margin-bottom: 20px;
  width: 100%;
}

.btn {
  flex: 1;
  padding: 14px 0; /* Botones mÃ¡s altos */
  border: none;
  border-radius: 12px; /* Bordes mÃ¡s redondeados */
  font-weight: 600;
  font-size: 1.0em;
  cursor: pointer;
  transition: all 0.25s ease;
  will-change: transform, box-shadow;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.btn-green {
  background: var(--primary-green);
  color: var(--white);
  box-shadow: 0 6px 20px rgba(104,181,83,0.25);
}
.btn-green:hover { 
  background: #5ca54a; 
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(104,181,83,0.35);
}

.watermark-toggle {
  margin: 10px 0 20px; /* MÃ¡s espacio */
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
  color: var(--muted);
  justify-content: center;
  cursor: pointer; /* Indica que es clickeable */
}

.watermark-toggle input[type="checkbox"] {
  transform: scale(1.2); /* Checkbox un poco mÃ¡s grande */
  accent-color: var(--primary-green); /* Color del checkbox */
}

.note {
  font-size: 0.85em; /* Texto mÃ¡s discreto */
  color: var(--muted);
  margin-top: 10px;
}

/* 2. Selector de Idioma mÃ¡s integrado */
#lang-selector {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 10;
}

#current-lang {
  cursor: pointer;
  background: var(--white);
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 7px 10px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.9em;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}
#current-lang:hover {
  background: #f9f9f9;
  border-color: #c7d8bf;
}

#lang-options {
  display: none;
  position: absolute;
  right: 0;
  top: 45px; /* MÃ¡s abajo para no chocar con el botÃ³n */
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 10px;
  box-shadow: 0 4px 15px var(--shadow-light);
  min-width: 100px;
  overflow: hidden;
}
.lang-option {
  padding: 10px 15px;
  cursor: pointer;
  font-weight: 600;
  color: var(--text-dark);
  transition: background 0.15s ease;
}
.lang-option:hover { background: var(--bg-light-green); }

/* 3. Popup de Ã‰xito mejorado */
.success-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  animation: fadeIn 0.3s ease-out;
}
.success-box {
  background: var(--white);
  padding: 30px 40px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 10px 40px var(--shadow-medium);
  transform: scale(0.9);
  animation: successScale 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes successScale {
  to { transform: scale(1); }
}
.success-box h3 { color: var(--primary-green); margin: 0 0 8px; font-size: 1.5em; font-weight: 700; }
.success-box p { color: var(--muted); font-size: 1em; margin: 0; }

/* Media queries para pantallas mÃ¡s pequeÃ±as */
@media (max-width: 380px) {
  .share-card { padding: 25px; }
  h2 { font-size: 1.4em; }
  p { font-size: 0.9em; }
  .btn { font-size: 0.95em; padding: 12px 0; }
  .row { gap: 8px; }
  .watermark-toggle { font-size: 0.85em; }
}

</style>
</head>
<body>

<a id="backBtn" class="back-button" href="principal.html">â¬… Volver</a>

<div id="lang-selector">
  <div id="current-lang">ğŸ‡ªğŸ‡¸</div>
  <div id="lang-options"></div>
</div>

<div class="wrap">
  <div class="share-card">
    <h2 id="shareTitle">ğŸ“¸ Comparte tu momento</h2>
    <p id="shareSub">Elige o toma una foto y compÃ¡rtela con tus amigos.</p>

    <div class="photo-container" id="photoContainer">
      <img id="photoPreview" class="photo-preview" alt="Vista previa">
      <p id="placeholderText" style="color:var(--muted); font-size:0.9em;">Haz clic para aÃ±adir una foto</p>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
    <input type="file" id="galleryInput" accept="image/*" style="display:none;">

    <div class="row">
      <button id="btnCamera" class="btn btn-green">ğŸ“· Tomar foto</button>
      <button id="btnGallery" class="btn btn-green">ğŸ–¼ï¸ Elegir foto</button>
    </div>

    <label class="watermark-toggle">
      <input type="checkbox" id="chkWatermark" checked>
      <span id="watermarkLabel">Incluir nombre del restaurante</span>
    </label>

    <button id="btnShare" class="btn btn-green" style="width:100%;">Compartir</button>
    <p class="note" id="note">Si no eliges foto, se compartirÃ¡ una tarjeta del restaurante.</p>
  </div>
</div>

<script>
const DEFAULT_CARD="img/logo35.png"; // Imagen por defecto si no se elige ninguna
const LOGO_WATERMARK_URL = "img/PataMig.png"; // RUTA DE TU LOGO
const FLAGS={es:"ğŸ‡ªğŸ‡¸",en:"ğŸ‡¬ğŸ‡§"}; // He simplificado a ES y EN, aÃ±ade mÃ¡s si tienes traducciones completas
const COPY={
Â es:{title:"Compartir experiencia Â· PataMig",shareTitle:"ğŸ“¸ Comparte tu momento",shareSub:"Elige o toma una foto y compÃ¡rtela con tus amigos.",note:"Si no eliges foto, se compartirÃ¡ una tarjeta del restaurante.",back:"â¬… Volver",shareBtn:"Compartir",takePhoto:"ğŸ“· Tomar foto",choosePhoto:"ğŸ–¼ï¸ Elegir foto",watermark:"Incluir nombre del restaurante",success:"âœ… Compartido con Ã©xito", redirecting:"Redirigiendo..."},
Â en:{title:"Share Experience Â· PataMig",shareTitle:"ğŸ“¸ Share your moment",shareSub:"Take or choose a photo and share with friends.",note:"If you don't choose a photo, a restaurant card will be shared.",back:"â¬… Back",shareBtn:"Share",takePhoto:"ğŸ“· Take photo",choosePhoto:"ğŸ–¼ï¸ Choose photo",watermark:"Include restaurant name",success:"âœ… Shared successfully", redirecting:"Redirecting..."}
};

let currentLang='es';
const cameraInput=document.getElementById('cameraInput');
const galleryInput=document.getElementById('galleryInput');
const photoPreview=document.getElementById('photoPreview');
const photoContainer=document.getElementById('photoContainer');
const placeholderText = document.getElementById('placeholderText'); // Nuevo
const btnCamera=document.getElementById('btnCamera');
const btnGallery=document.getElementById('btnGallery');
const btnShare=document.getElementById('btnShare');
const backBtn=document.getElementById('backBtn');
const noteEl=document.getElementById('note');
const currentLangDiv=document.getElementById('current-lang');
const optionsDiv=document.getElementById('lang-options');
const chkWatermark=document.getElementById('chkWatermark');
const watermarkLabel=document.getElementById('watermarkLabel');

function setLang(lang){
Â  const c=COPY[lang];
Â  document.title=c.title;
Â  document.getElementById('shareTitle').textContent=c.shareTitle;
Â  document.getElementById('shareSub').textContent=c.shareSub;
Â  btnShare.textContent=c.shareBtn;
Â  backBtn.textContent=c.back;
Â  noteEl.textContent=c.note;
Â  btnCamera.textContent=c.takePhoto;
Â  btnGallery.textContent=c.choosePhoto;
Â  watermarkLabel.textContent=c.watermark;
Â  currentLangDiv.textContent=FLAGS[lang];
  currentLang = lang; // Actualizar el idioma actual
}

function initLangSelector(){
Â  optionsDiv.innerHTML="";
Â  Object.keys(COPY).forEach(code=>{
Â  Â  const opt=document.createElement('div');
Â  Â  opt.className='lang-option';
Â  Â  opt.textContent=`${FLAGS[code]} ${code.toUpperCase()}`;
Â  Â  opt.onclick=()=>{ setLang(code); optionsDiv.style.display='none'; };
Â  Â  optionsDiv.appendChild(opt);
Â  });
Â  currentLangDiv.onclick=e=>{
Â  Â  e.stopPropagation();
Â  Â  optionsDiv.style.display = optionsDiv.style.display==='block' ? 'none' : 'block';
Â  };
Â  document.addEventListener('click', e=>{
Â  Â  if(!document.getElementById('lang-selector').contains(e.target)){
Â  Â  Â  optionsDiv.style.display='none';
Â  Â  }
Â  });
}

initLangSelector();
setLang(currentLang);

// Abrir el selector de archivos al hacer clic en el contenedor de la foto
photoContainer.onclick = () => galleryInput.click();

btnCamera.onclick=()=>cameraInput.click();
btnGallery.onclick=()=>galleryInput.click();

let selectedFile=null;
function handleFileInput(input){
Â  const f=input.files?.[0];
Â  if(!f) return;
Â  selectedFile=f;
Â  photoPreview.src=URL.createObjectURL(f);
Â  photoContainer.style.display='flex'; // Asegurarse que se vea
  placeholderText.style.display = 'none'; // Ocultar texto de placeholder
}
cameraInput.onchange=()=>handleFileInput(cameraInput);
galleryInput.onchange=()=>handleFileInput(galleryInput);


// --- FUNCIÃ“N PARA AÃ‘ADIR MARCA DE AGUA (CON LOGO) ---
async function addWatermarkToImage(file){
Â  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.crossOrigin = "anonymous"; // Importante para cargar imÃ¡genes de otros dominios
    img.src = URL.createObjectURL(file);

    img.onload = async () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // Cargar el logo
      const logo = new Image();
      logo.crossOrigin = "anonymous";
      logo.src = LOGO_WATERMARK_URL;

      logo.onload = () => {
        // Calcular tamaÃ±o y posiciÃ³n del logo
        const logoNaturalWidth = logo.naturalWidth;
        const logoNaturalHeight = logo.naturalHeight;
        
        const targetLogoHeight = Math.max(50, canvas.height * 0.1); // Altura mÃ­nima de 50px o 10% del alto de la imagen
        const targetLogoWidth = (logoNaturalWidth / logoNaturalHeight) * targetLogoHeight;
        
        const margin = Math.max(30, canvas.height * 0.05); // Margen dinÃ¡mico
        const x = canvas.width - targetLogoWidth - margin;
        const y = canvas.height - targetLogoHeight - margin;

        // Dibujar un fondo semitransparente detrÃ¡s del logo (opcional, pero mejora la visibilidad)
        ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; // Fondo blanco semitransparente
        ctx.roundRect(x - 10, y - 10, targetLogoWidth + 20, targetLogoHeight + 20, 10); // Un poco mÃ¡s grande para el padding
        ctx.fill();

        // Dibujar el logo
        ctx.drawImage(logo, x, y, targetLogoWidth, targetLogoHeight);

        canvas.toBlob(b=>{
Â  Â  Â  Â  Â  resolve(new File([b],"patamig_momento.jpg",{type:"image/jpeg"}));
Â  Â  Â  Â  },"image/jpeg",0.9);
      };

      logo.onerror = () => reject(new Error("Error al cargar el logo para la marca de agua."));
    };
    img.onerror = () => reject(new Error("Error al cargar la imagen seleccionada para la marca de agua."));
Â  });
}


function showSuccessMessage(){
Â  const popup=document.createElement('div');
Â  popup.className='success-popup';
Â  popup.innerHTML=`<div class="success-box"><h3>${COPY[currentLang].success}</h3><p>${COPY[currentLang].redirecting}</p></div>`;
Â  document.body.appendChild(popup);
Â  setTimeout(()=>{ window.location.href="principal.html"; },2000);
}

async function shareExperience(e){
Â  e&&e.preventDefault();
Â  try{
Â  Â  let baseFile;
Â  Â  if(selectedFile){
Â  Â  Â  baseFile=selectedFile;
Â  Â  } else {
Â  Â  Â  const res=await fetch(DEFAULT_CARD);
Â  Â  Â  const blob=await res.blob();
Â  Â  Â  baseFile=new File([blob],"patamig_card.jpg",{type:"image/jpeg"});
Â  Â  }
Â  Â  let fileToShare=baseFile;
Â  Â  if(chkWatermark.checked){
Â  Â  Â  fileToShare=await addWatermarkToImage(baseFile);
Â  Â  }

    // Usar la API de Web Share si estÃ¡ disponible
Â  Â  if(navigator.canShare?.({files:[fileToShare]})){
Â  Â  Â  await navigator.share({
        files:[fileToShare],
        title: COPY[currentLang].shareTitle,
        text: COPY[currentLang].shareSub
      });
Â  Â  Â  showSuccessMessage();
Â  Â  } else {
Â  Â  Â  // Si no, intentar abrir en una nueva ventana (menos ideal para compartir)
Â  Â  Â  const url=URL.createObjectURL(fileToShare);
Â  Â  Â  window.open(url,"_blank");
Â  Â  Â  showSuccessMessage(); // Mostrar mensaje de Ã©xito aunque no sea una app de compartir nativa
Â  Â  }
Â  }catch(err){ 
    // Capturar si el usuario cancela la acciÃ³n de compartir
    if (err.name === 'AbortError') {
        console.log("Compartir cancelado por el usuario.");
    } else {
        console.error("Error al compartir:", err);
    }
  }
}

btnShare.onclick=shareExperience;

// Si no hay foto seleccionada al inicio, mostrar el placeholder
if (!selectedFile) {
    photoContainer.style.display = 'flex';
    placeholderText.style.display = 'block';
    photoPreview.style.display = 'none'; // Ocultar img si no hay src
}
</script>
</body>
</html>
