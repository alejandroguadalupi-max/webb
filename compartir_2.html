<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title data-lang="title">Compartir experiencia ¬∑ PataMig</title>
<style>
:root {
  --primary-green: #68B553; /* mismo verde claro de la principal */
  --bg-light-green: #E8F5E1;
  --text-dark: #333;
  --muted: #6b7280;
  --border: #d0e2c8;
  --white: #fff;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg-light-green);
  color: var(--text-dark);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.wrap {
  width: 100%;
  max-width: 420px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

header {
  position: absolute;
  top: 16px;
  left: 16px;
}

.back {
  background: var(--primary-green);
  color: var(--white);
  padding: 8px 14px;
  border-radius: 10px;
  text-decoration: none;
  font-weight: 600;
  font-size: 15px;
}

.share-card {
  background: var(--white);
  border-radius: 14px;
  padding: 24px 20px;
  border: 1px solid var(--border);
  width: 100%;
  text-align: center;
}

h2 {
  margin: 0 0 8px;
  font-size: 1.25rem;
}

p {
  margin: 0 0 12px;
  font-size: 14px;
  color: var(--muted);
}

.photo-container {
  width: 100%;
  aspect-ratio: 4/3;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--white);
  overflow: hidden;
  display: none;
  margin-bottom: 12px;
}

.photo-preview {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.row {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-bottom: 12px;
  width: 100%;
}

.btn {
  flex: 1;
  padding: 12px 0;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.btn-green {
  background: var(--primary-green);
  color: var(--white);
}
.btn-green:hover { background: #5ca54a; }

.watermark-toggle {
  margin: 8px 0 14px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: var(--muted);
  justify-content: center;
}

.note {
  font-size: 13px;
  color: var(--muted);
}

#lang-selector {
  position: absolute;
  top: 16px;
  right: 16px;
}

#current-lang {
  cursor: pointer;
  background: rgba(0,0,0,0.05);
  padding: 6px 8px;
  border-radius: 8px;
}

#lang-options {
  display: none;
  position: absolute;
  right: 0;
  top: 40px;
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
}
.lang-option {
  padding: 8px 10px;
  cursor: pointer;
  font-weight: 600;
}
.lang-option:hover { background: #f1f5f9; }

.success-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
}
.success-box {
  background: var(--white);
  padding: 20px 28px;
  border-radius: 12px;
  text-align: center;
}
.success-box h3 { color: var(--primary-green); margin: 0 0 4px; font-size: 18px; }
.success-box p { color: var(--muted); font-size: 14px; margin: 0; }

</style>
</head>
<body>

<div id="lang-selector">
  <div id="current-lang">üá™üá∏</div>
  <div id="lang-options"></div>
</div>

<div class="wrap">
  <header>
    <a id="backBtn" class="back" href="principal.html">‚¨Ö Volver</a>
  </header>

  <div class="share-card">
    <h2 id="shareTitle">üì∏ Comparte tu momento</h2>
    <p id="shareSub">Elige o toma una foto y comp√°rtela con tus amigos.</p>

    <div class="photo-container" id="photoContainer">
      <img id="photoPreview" class="photo-preview" alt="Vista previa">
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
    <input type="file" id="galleryInput" accept="image/*" style="display:none;">

    <div class="row">
      <button id="btnCamera" class="btn btn-green">üì∑ Tomar foto</button>
      <button id="btnGallery" class="btn btn-green">üñºÔ∏è Elegir foto</button>
    </div>

    <label class="watermark-toggle">
      <input type="checkbox" id="chkWatermark" checked>
      <span id="watermarkLabel">Incluir nombre del restaurante</span>
    </label>

    <button id="btnShare" class="btn btn-green" style="width:100%;">Compartir</button>
    <p class="note" id="note">Si no eliges foto, se compartir√° una tarjeta del restaurante.</p>
  </div>
</div>

<script>
const DEFAULT_CARD="img/logo35.png";
const FLAGS={es:"üá™üá∏",en:"üá¨üáß",fr:"üá´üá∑",de:"üá©üá™"};
const COPY={
 es:{title:"Compartir experiencia ¬∑ PataMig",shareTitle:"üì∏ Comparte tu momento",shareSub:"Elige o toma una foto y comp√°rtela con tus amigos.",note:"Si no eliges foto, se compartir√° una tarjeta del restaurante.",back:"‚¨Ö Volver",shareBtn:"Compartir",takePhoto:"üì∑ Tomar foto",choosePhoto:"üñºÔ∏è Elegir foto",watermark:"Incluir nombre del restaurante",success:"Compartido con √©xito"},
 en:{title:"Share Experience ¬∑ PataMig",shareTitle:"üì∏ Share your moment",shareSub:"Take or choose a photo and share with friends.",note:"If you don't choose a photo, a restaurant card will be shared.",back:"‚¨Ö Back",shareBtn:"Share",takePhoto:"üì∑ Take photo",choosePhoto:"üñºÔ∏è Choose photo",watermark:"Include restaurant name",success:"Shared successfully"}
};

let currentLang='es';
const cameraInput=document.getElementById('cameraInput');
const galleryInput=document.getElementById('galleryInput');
const photoPreview=document.getElementById('photoPreview');
const photoContainer=document.getElementById('photoContainer');
const btnCamera=document.getElementById('btnCamera');
const btnGallery=document.getElementById('btnGallery');
const btnShare=document.getElementById('btnShare');
const backBtn=document.getElementById('backBtn');
const noteEl=document.getElementById('note');
const currentLangDiv=document.getElementById('current-lang');
const optionsDiv=document.getElementById('lang-options');
const chkWatermark=document.getElementById('chkWatermark');
const watermarkLabel=document.getElementById('watermarkLabel');

function setLang(lang){
  const c=COPY[lang];
  document.title=c.title;
  document.getElementById('shareTitle').textContent=c.shareTitle;
  document.getElementById('shareSub').textContent=c.shareSub;
  btnShare.textContent=c.shareBtn;
  backBtn.textContent=c.back;
  noteEl.textContent=c.note;
  btnCamera.textContent=c.takePhoto;
  btnGallery.textContent=c.choosePhoto;
  watermarkLabel.textContent=c.watermark;
  currentLangDiv.textContent=FLAGS[lang];
}

function initLangSelector(){
  optionsDiv.innerHTML="";
  Object.keys(COPY).forEach(code=>{
    const opt=document.createElement('div');
    opt.className='lang-option';
    opt.textContent=`${FLAGS[code]} ${code.toUpperCase()}`;
    opt.onclick=()=>{ setLang(code); optionsDiv.style.display='none'; };
    optionsDiv.appendChild(opt);
  });
  currentLangDiv.onclick=e=>{
    e.stopPropagation();
    optionsDiv.style.display = optionsDiv.style.display==='block' ? 'none' : 'block';
  };
  document.addEventListener('click', e=>{
    if(!document.getElementById('lang-selector').contains(e.target)){
      optionsDiv.style.display='none';
    }
  });
}

initLangSelector();
setLang(currentLang);

btnCamera.onclick=()=>cameraInput.click();
btnGallery.onclick=()=>galleryInput.click();

let selectedFile=null;
function handleFileInput(input){
  const f=input.files?.[0];
  if(!f) return;
  selectedFile=f;
  photoPreview.src=URL.createObjectURL(f);
  photoContainer.style.display='block';
}
cameraInput.onchange=()=>handleFileInput(cameraInput);
galleryInput.onchange=()=>handleFileInput(galleryInput);

async function addWatermarkToImage(file){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      canvas.width=img.width; canvas.height=img.height;
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const fontSize=Math.max(16,canvas.width*0.045);
      const text="PataMig";
      ctx.font=`700 ${fontSize}px 'Segoe UI', Roboto, sans-serif`;
      ctx.fillStyle="rgba(255,255,255,0.8)";
      const padding=fontSize*0.5;
      const textWidth=ctx.measureText(text).width+padding*2;
      const rectHeight=fontSize*1.8;
      const x=canvas.width-textWidth-30;
      const y=canvas.height-rectHeight-40;
      ctx.fillRect(x,y,textWidth,rectHeight);
      ctx.fillStyle="#1f2937";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(text,x+textWidth/2,y+rectHeight/2.1);
      canvas.toBlob(b=>{
        resolve(new File([b],"patamig_momento.jpg",{type:"image/jpeg"}));
      },"image/jpeg",0.9);
    };
    img.src=URL.createObjectURL(file);
  });
}

function showSuccessMessage(){
  const popup=document.createElement('div');
  popup.className='success-popup';
  popup.innerHTML=`<div class="success-box"><h3>‚úÖ Compartido con √©xito</h3><p>Redirigiendo...</p></div>`;
  document.body.appendChild(popup);
  setTimeout(()=>{ window.location.href="principal.html"; },2000);
}

async function shareExperience(e){
  e&&e.preventDefault();
  try{
    let baseFile;
    if(selectedFile){
      baseFile=selectedFile;
    } else {
      const res=await fetch(DEFAULT_CARD);
      const blob=await res.blob();
      baseFile=new File([blob],"patamig_card.jpg",{type:"image/jpeg"});
    }
    let fileToShare=baseFile;
    if(chkWatermark.checked){
      fileToShare=await addWatermarkToImage(baseFile);
    }

    if(navigator.canShare?.({files:[fileToShare]})){
      await navigator.share({files:[fileToShare]});
      showSuccessMessage();
    } else {
      const url=URL.createObjectURL(fileToShare);
      window.open(url,"_blank");
      showSuccessMessage();
    }
  }catch(err){ console.log("Error o cancelado:", err); }
}

btnShare.onclick=shareExperience;
</script>
</body>
</html>
