<script>
const RESTAURANT_NAME="Terraza Casablanca Las Canteras";
const GOOGLE_MAPS_LINK="https://goo.gl/maps/F5r1E7vAeqkz2nYZ9";
const DEFAULT_CARD="img/logo35.png";
const FLAGS={es:"ðŸ‡ªðŸ‡¸",en:"ðŸ‡¬ðŸ‡§",fr:"ðŸ‡«ðŸ‡·",de:"ðŸ‡©ðŸ‡ª"};

const COPY={
  es:{
    shareTitle:"ðŸ“¸ Comparte tu momento",
    shareSub:"Elige o toma una foto y compÃ¡rtela con tus amigos.",
    btnCamera:"ðŸ“· Tomar foto",
    btnGallery:"ðŸ–¼ï¸ Elegir foto",
    shareBtn:"Compartir",
    note:"Si no eliges foto, se compartirÃ¡ una tarjeta del restaurante.",
    back:"â¬… Volver",
    shareMsg:`Acabo de disfrutar en ${RESTAURANT_NAME} ðŸ¸âœ¨ Â¡Tienes que venir!`
  },
  en:{
    shareTitle:"ðŸ“¸ Share your moment",
    shareSub:"Take or choose a photo and share with friends.",
    btnCamera:"ðŸ“· Take photo",
    btnGallery:"ðŸ–¼ï¸ Choose photo",
    shareBtn:"Share",
    note:"If you don't choose a photo, a restaurant card will be shared.",
    back:"â¬… Back",
    shareMsg:`Just had a great time at ${RESTAURANT_NAME} ðŸ¸âœ¨ Highly recommended!`
  },
  fr:{
    shareTitle:"ðŸ“¸ Partage ton moment",
    shareSub:"Prends ou choisis une photo et partage-la avec tes amis.",
    btnCamera:"ðŸ“· Prendre une photo",
    btnGallery:"ðŸ–¼ï¸ Choisir une photo",
    shareBtn:"Partager",
    note:"Si tu ne choisis pas de photo, une carte du restaurant sera partagÃ©e.",
    back:"â¬… Retour",
    shareMsg:`Je viens de passer un bon moment Ã  ${RESTAURANT_NAME} ðŸ¸âœ¨ Ã€ dÃ©couvrir absolument !`
  },
  de:{
    shareTitle:"ðŸ“¸ Teile deinen Moment",
    shareSub:"Mach ein Foto oder wÃ¤hle eines aus und teile es mit Freunden.",
    btnCamera:"ðŸ“· Foto aufnehmen",
    btnGallery:"ðŸ–¼ï¸ Foto auswÃ¤hlen",
    shareBtn:"Teilen",
    note:"Wenn du kein Foto auswÃ¤hlst, wird eine Restaurantkarte geteilt.",
    back:"â¬… ZurÃ¼ck",
    shareMsg:`Gerade eine tolle Zeit bei ${RESTAURANT_NAME} ðŸ¸âœ¨ Sehr zu empfehlen!`
  }
};

let currentLang=localStorage.getItem("userLang")||navigator.language.slice(0,2)||"es";
if(!COPY[currentLang])currentLang="es";

const wrap=document.getElementById("wrap");
const cameraInput=document.getElementById("cameraInput");
const galleryInput=document.getElementById("galleryInput");
const photoPreview=document.getElementById("photoPreview");
const photoContainer=document.getElementById("photoContainer");
const btnCamera=document.getElementById("btnCamera");
const btnGallery=document.getElementById("btnGallery");
const btnShare=document.getElementById("btnShare");
const backBtn=document.getElementById("backBtn");
const noteEl=document.getElementById("note");

function setLang(lang){
  const t=COPY[lang]||COPY.es;
  document.getElementById("shareTitle").textContent=t.shareTitle;
  document.getElementById("shareSub").textContent=t.shareSub;
  btnCamera.textContent=t.btnCamera;
  btnGallery.textContent=t.btnGallery;
  btnShare.textContent=t.shareBtn;
  noteEl.textContent=t.note;
  backBtn.textContent=t.back;
  document.getElementById("current-lang").textContent=FLAGS[lang]||"ðŸ‡ªðŸ‡¸";
  localStorage.setItem("userLang",lang);
}
setLang(currentLang);

// selector de idioma
const currentLangDiv=document.getElementById("current-lang");
const langOptions=document.getElementById("lang-options");
Object.keys(COPY).forEach(code=>{
  const opt=document.createElement("div");
  opt.className="lang-option";
  opt.textContent=`${FLAGS[code]} ${code.toUpperCase()}`;
  opt.onclick=()=>setLang(code);
  langOptions.appendChild(opt);
});
currentLangDiv.onclick=(e)=>{
  e.stopPropagation();
  langOptions.style.display=langOptions.style.display==="block"?"none":"block";
};
document.addEventListener("click",()=>langOptions.style.display="none");

// carga foto
let selectedFile=null;
cameraInput.onchange=()=>handleFile(cameraInput);
galleryInput.onchange=()=>handleFile(galleryInput);
function handleFile(input){
  const file=input.files?.[0];
  if(!file)return;
  selectedFile=file;
  photoPreview.src=URL.createObjectURL(file);
  photoContainer.style.display="block";
  wrap.classList.add("centered");
}

// Marca de agua moderna
async function addWatermarkToImage(file){
  return new Promise((resolve)=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement("canvas");
      const ctx=canvas.getContext("2d");
      canvas.width=img.width;
      canvas.height=img.height;
      ctx.drawImage(img,0,0);

      const fontSize=canvas.width*0.045;
      const text="Terraza Casablanca";
      ctx.font=`700 ${fontSize}px 'Segoe UI', Roboto, sans-serif`;
      const textWidth=ctx.measureText(text).width;
      const padding=fontSize*0.6;
      const rectWidth=textWidth+padding*2;
      const rectHeight=fontSize*1.8;
      const x=canvas.width-rectWidth-60;
      const y=canvas.height-rectHeight-100;

      // fondo moderno dorado con leve desenfoque
      ctx.fillStyle="rgba(255, 215, 0, 0.85)";
      ctx.roundRect(x,y,rectWidth,rectHeight,14);
      ctx.shadowColor="rgba(0,0,0,0.25)";
      ctx.shadowBlur=8;
      ctx.fill();
      ctx.shadowBlur=0;

      // texto centrado, con leve inclinaciÃ³n
      ctx.save();
      ctx.translate(canvas.width/2,canvas.height/2);
      ctx.rotate(-0.02);
      ctx.restore();
      ctx.fillStyle="#1a1a1a";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.fillText(text,x+rectWidth/2,y+rectHeight/2.1);

      canvas.toBlob(b=>{
        resolve(new File([b],"casablanca_momento.jpg",{type:"image/jpeg"}));
      },"image/jpeg",0.9);
    };
    img.src=URL.createObjectURL(file);
  });
}

CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
  if(w<2*r)r=w/2;if(h<2*r)r=h/2;
  this.beginPath();
  this.moveTo(x+r,y);
  this.arcTo(x+w,y,x+w,y+h,r);
  this.arcTo(x+w,y+h,x,y+h,r);
  this.arcTo(x,y+h,x,y,r);
  this.arcTo(x,y,x+w,y,r);
  this.closePath();
  return this;
};

// compartir
btnCamera.onclick=()=>cameraInput.click();
btnGallery.onclick=()=>galleryInput.click();

btnShare.onclick=async(e)=>{
  e.preventDefault();
  const t=COPY[currentLang];
  const text=`${t.shareMsg}\nðŸ“ ${RESTAURANT_NAME}\n${GOOGLE_MAPS_LINK}`;

  try{
    let fileToShare;
    if(selectedFile){
      fileToShare=await addWatermarkToImage(selectedFile);
    }else{
      const res=await fetch(DEFAULT_CARD);
      const blob=await res.blob();
      const baseFile=new File([blob],"casablanca_card.jpg",{type:"image/jpeg"});
      fileToShare=await addWatermarkToImage(baseFile);
    }

    if(navigator.canShare?.({files:[fileToShare],text})){
      await navigator.share({files:[fileToShare],text});
    }else{
      await navigator.share({text});
    }

    // compatibilidad Android/iOS
    setTimeout(()=>{
      sessionStorage.setItem("sharedMessage","ðŸ’› Gracias por compartir tu experiencia");
      window.location.href="restaurante_casablanca.html?shared=1";
    },800);

  }catch(err){
    // Si cancela o Android se queda en WhatsApp, forzar retorno igualmente
    console.log("Cancelado o error:",err);
    setTimeout(()=>{
      sessionStorage.setItem("sharedMessage","ðŸ’› Gracias por compartir tu experiencia");
      window.location.href="restaurante_casablanca.html?shared=1";
    },1200);
  }
};
</script>
