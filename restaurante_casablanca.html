<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0b0f18">
<title>¬øC√≥mo fue tu experiencia?</title>
<style>
  :root{
    --text:#0b0f18;
    --muted:#566073;
    --accent:#2563eb;
    --ok:#16a34a;
    --card:#ffffff;
    --bg:#f7f7fb;
    --border:#e6e8ee;
  }

  *,*::before,*::after{box-sizing:border-box}
  html,body{margin:0; height:100%}

  body{
    min-height:100svh;
    display:flex; align-items:center; justify-content:center;
    padding:12px;
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, #f1f5ff 0, #fff 60%) no-repeat,
      var(--bg);
  }

  .card{
    width:min(580px, 100%);
    max-height:100svh;
    display:flex; flex-direction:column; gap:14px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:18px;
    box-shadow:0 18px 45px rgba(12,20,33,.08);
    position:relative;
  }

  /* Selector de idioma */
  #lang-selector{
    position:absolute;
    top:12px;
    right:12px;
    z-index:10;
    font-size:0;
  }
  #current-lang{
    cursor:pointer;
    font-size:22px;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(0,0,0,.04);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition:background .2s ease;
  }
  #current-lang:hover{ background:rgba(0,0,0,.08); }

  #lang-options{
    display:none;
    position:absolute;
    top:calc(100% + 6px);
    right:0;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
    padding:4px;
    min-width:90px;
    text-align:center;
  }

  .lang-option{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:6px;
    padding:6px;
    font-size:14px;
    font-weight:600;
    border-radius:8px;
    cursor:pointer;
    transition:background-color .2s ease;
  }
  .lang-option:hover{ background-color:var(--bg); }

  /* Branding */
  .brand{display:flex; flex-direction:column; align-items:center; gap:6px}
  .logo{width:68px; height:68px; border-radius:50%; overflow:hidden; display:grid; place-items:center; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.08)}
  .logo img{width:100%; height:100%; object-fit:cover}
  .brand h1{margin:6px 0 0; font-size:22px; line-height:1.2; text-align:center}
  .brand p{margin:2px 0 0; color:var(--muted); font-size:14px; text-align:center}

  .grid{display:grid; gap:12px}
  @media(min-width:560px){ .grid{grid-template-columns:1fr 1fr} }

  /* Tarjetas */
  .tile{
    border:none;
    border:1px solid rgba(0,0,0,0.05);
    border-radius:16px;
    background:#fff;
    padding:14px;
    display:flex;
    flex-direction:column;
    align-items:center;
    transition:box-shadow .2s ease, transform .1s ease;
  }
  .tile:hover{
    box-shadow:0 4px 14px rgba(0,0,0,.06);
    transform:translateY(-2px);
  }

  .tile h2{margin:0 0 6px; font-size:16px; text-align:center}
  .tile p{margin:0 0 10px; font-size:13px; color:var(--muted); text-align:center}

  .btn{
    display:block; width:100%; text-align:center; text-decoration:none;
    padding:14px 16px; border-radius:12px; font-weight:800; font-size:15px; color:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,.1); transition:transform .06s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn-google{background:linear-gradient(180deg,#6baeff,var(--accent))}
  .btn-private{background:linear-gradient(180deg,#4ade80,var(--ok))}

  .btn-share{
    display:block;
    width:100%;
    text-align:center;
    padding:10px;
    border-radius:10px;
    font-size:13px;
    font-weight:600;
    color:var(--accent);
    border:1px dashed var(--accent);
    background:transparent;
    transition:background .2s,color .2s,border-color .2s;
  }
  .btn-share:hover{
    background:var(--accent);
    color:#fff;
    border-color:transparent;
  }

  .note{font-size:12px; color:var(--muted); text-align:center}

  @media(max-width:360px){
    .brand h1{font-size:20px}
    .btn{font-size:14px; padding:12px 14px}
    .tile p{font-size:12px}
    .btn-share{font-size:12px; padding:8px}
  }
</style>
</head>
<body>
<main class="card" id="mainCard" role="main" aria-labelledby="t">
  <!-- Selector de idioma -->
  <div id="lang-selector" aria-haspopup="true">
    <div id="current-lang" aria-label="Cambiar idioma"></div>
    <div id="lang-options" role="menu" aria-hidden="true"></div>
  </div>

  <header class="brand">
    <div class="logo">
      <img src="img/imagen_circular_recortada.png" alt="Logo Casablanca">
    </div>
    <h1 id="t"><span id="brandName">Restaurante Casablanca</span></h1>
    <p id="subtitle">Cu√©ntanos en 10 segundos c√≥mo fue todo.</p>
  </header>

  <div class="grid">
    <section class="tile" aria-labelledby="publicTitle">
      <h2 id="publicTitle">‚≠ê Rese√±a p√∫blica</h2>
      <p id="publicText"> Si te gust√≥, tu rese√±a nos ayuda a crecer.</p>
      <!-- abrimos EN LA MISMA PESTA√ëA para garantizar que "Atr√°s" vuelva correctamente -->
      <a id="btnGoogle" class="btn btn-google" rel="noopener">Dejar rese√±a en Google</a>
      <div class="note" id="publicNote">Queda visible para todos.</div>
    </section>

    <section class="tile" aria-labelledby="privateTitle">
      <h2 id="privateTitle">üìù Comentario privado</h2>
      <p id="privateText">Si algo fall√≥, cu√©ntanos y lo arreglamos contigo.</p>
      <!-- abrimos EN LA MISMA PESTA√ëA para garantizar que "Atr√°s" vuelva correctamente -->
      <a id="btnPrivate" class="btn btn-private" rel="noopener">Enviar comentario</a>
      <div class="note" id="privateNote">Solo lo vemos nosotros.</div>
    </section>
  </div>

  <!-- enlace interno a compartir (misma pesta√±a por defecto) -->
  <a id="openShare" href="compartir.html" class="btn btn-share">üì∏ Compartir experiencia con amigos</a>

  <p class="note" id="thanks"><strong>¬°Gracias por tu tiempo!</strong></p>
</main>

<script>
/* ----------------------------
   CONFIG
   ---------------------------- */
const RESTAURANT_NAME = "Restaurante Casablanca ¬∑ Las Canteras";
const GOOGLE_MAPS_SHORT = "https://maps.app.goo.gl/CasablancaLasCanteras";
const TALLY_LINKS = { es:"https://tally.so/r/w2Qla9", en:"https://tally.so/r/w20k9D", de:"https://tally.so/r/mBN1q1", fr:"https://tally.so/r/mek0Dk" };
const FLAGS = { es:"üá™üá∏", en:"üá¨üáß", de:"üá©üá™", fr:"üá´üá∑" };

const COPY = {
  es:{pageTitle:"¬øC√≥mo fue tu experiencia?", subtitle:"Cu√©ntanos en 10 segundos c√≥mo fue todo.", publicTitle:"‚≠ê Rese√±a p√∫blica", publicText:"Si te gust√≥, tu rese√±a nos ayuda a crecer.", publicBtn:"Dejar rese√±a en Google", publicNote:"Queda visible para todos.", privateTitle:"üìù Comentario privado", privateText:"Si algo fall√≥, cu√©ntanos y lo arreglamos contigo.", privateBtn:"Enviar comentario", privateNote:"Solo lo vemos nosotros.", shareBtn:"Compartir experiencia con amigos", thanks:"¬°Gracias por tu tiempo!"},
  en:{pageTitle:"How was your experience?", subtitle:"Tell us in 10 seconds how it went.", publicTitle:"‚≠ê Public review", publicText:"Your review helps us on Google.", publicBtn:"Leave a review", publicNote:"Visible to everyone.", privateTitle:"üìù Private feedback", privateText:"If something went wrong, tell us and we‚Äôll fix it.", privateBtn:"Send feedback", privateNote:"Only we can see it.", shareBtn:"Share experience with friends", thanks:"Thanks for your time!"},
  de:{pageTitle:"Wie war Ihre Erfahrung?", subtitle:"Erz√§hlen Sie uns in 10 Sekunden, wie alles war.", publicTitle:"‚≠ê √ñffentliche Bewertung", publicText:"Ihre Bewertung hilft uns bei Google.", publicBtn:"Bewertung abgeben", publicNote:"F√ºr alle sichtbar.", privateTitle:"üìù Privates Feedback", privateText:"Wenn etwas schiefging, sagen Sie es uns bitte.", privateBtn:"Feedback senden", privateNote:"Nur wir k√∂nnen es sehen.", shareBtn:"Erfahrung mit Freunden teilen", thanks:"Vielen Dank f√ºr Ihre Zeit!"},
  fr:{pageTitle:"Comment √©tait votre exp√©rience ?", subtitle:"Racontez-nous en 10 secondes comment tout s'est pass√©.", publicTitle:"‚≠ê Avis public", publicText:"Votre avis nous aide sur Google.", publicBtn:"Laisser un avis", publicNote:"Visible par tout le monde.", privateTitle:"üìù Commentaire priv√©", privateText:"S'il y a eu un souci, dites-le nous.", privateBtn:"Envoyer un commentaire", privateNote:"Visible uniquement par nous.", shareBtn:"Partager avec des amis", thanks:"Merci pour votre temps !"}
};
const LANGS = Object.keys(COPY);
const MAIN_PAGE = "restaurante_casablanca.html"; // fallback principal

/* ----------------------------
   Detectar idioma y aplicar textos
   ---------------------------- */
function getInitialLang(){
  const saved = localStorage.getItem('userLang');
  if(saved && COPY[saved]) return saved;
  const browser = navigator.languages || [navigator.language || 'es'];
  for(const b of browser){
    const c = b.slice(0,2).toLowerCase();
    if(COPY[c]) return c;
  }
  return 'es';
}

function setLang(lang){
  if(!COPY[lang]) lang='es';
  const d = COPY[lang];
  document.documentElement.lang = lang;
  document.title = d.pageTitle;
  document.getElementById('subtitle').textContent = d.subtitle;
  document.getElementById('publicTitle').textContent = d.publicTitle;
  document.getElementById('publicText').textContent = d.publicText;
  document.getElementById('btnGoogle').textContent = d.publicBtn;
  document.getElementById('publicNote').textContent = d.publicNote;
  document.getElementById('privateTitle').textContent = d.privateTitle;
  document.getElementById('privateText').textContent = d.privateText;
  document.getElementById('btnPrivate').textContent = d.privateBtn;
  document.getElementById('privateNote').textContent = d.privateNote;
  document.getElementById('openShare').textContent = "üì∏ " + d.shareBtn;
  document.getElementById('thanks').innerHTML = `<strong>${d.thanks}</strong>`;
  document.getElementById('btnGoogle').href = GOOGLE_MAPS_SHORT;
  document.getElementById('btnPrivate').href = TALLY_LINKS[lang] || TALLY_LINKS['es'];
  document.getElementById('current-lang').textContent = FLAGS[lang];
  localStorage.setItem('userLang', lang);
  document.getElementById('lang-options').style.display='none';
}

/* ----------------------------
   Inicializar selector de idioma
   ---------------------------- */
function initLangSelector(){
  const currentLangDiv = document.getElementById('current-lang');
  const optionsDiv = document.getElementById('lang-options');

  const initialLang = getInitialLang();
  setLang(initialLang);

  LANGS.forEach(code=>{
    const opt = document.createElement('div');
    opt.className='lang-option';
    opt.textContent=`${FLAGS[code]} ${code.toUpperCase()}`;
    opt.addEventListener('click',()=>setLang(code));
    optionsDiv.appendChild(opt);
  });

  currentLangDiv.addEventListener('click', e=>{
    e.stopPropagation();
    optionsDiv.style.display = optionsDiv.style.display==='block'?'none':'block';
  });

  document.addEventListener('click', e=>{
    if(!document.getElementById('lang-selector').contains(e.target)){
      optionsDiv.style.display='none';
    }
  });
}

/* ----------------------------
   NAVIGACION A ENLACES EXTERNOS
   - IMPORTANTE: abrimos enlaces externos en la MISMA pesta√±a
   - as√≠, el bot√≥n atr√°s vuelve siempre a esta p√°gina (o, si hay alguna anomal√≠a
     en el historial, forzamos la redirecci√≥n al MAIN_PAGE)
   ---------------------------- */
function navigateSameTab(url){
  // Guardamos una marca para detectar que venimos desde aqu√≠ (opcional)
  try{ sessionStorage.setItem('cameFromMain', location.href); }catch(e){}
  // Navegamos en la misma pesta√±a (no target="_blank")
  location.href = url;
}

/* Forzar comportamiento de "Volver" seguro.
   Intentamos history.back(); si no funciona (no cambia history), redirigimos
   al MAIN_PAGE pasado como fallback. */
function goBackToMain(fallback = MAIN_PAGE){
  const prevLen = history.length;
  history.back();
  // Si tras 350ms la longitud de history es la misma, asumimos que no hubo back efectivo
  setTimeout(() => {
    if (history.length === prevLen) {
      location.href = fallback;
    }
  }, 350);
}

/* Interceptar evento popstate para casos de webviews/external returns:
   si la referencia viene de otro dominio que no es este site y el history
   no apunta a una ruta local, redirigimos al MAIN_PAGE. */
function handlePopStateFallback(){
  // Si el referrer es de otro host y la ruta actual es la p√°gina principal, no hacemos nada.
  // Pero si detectamos que el usuario vino desde un origin distinto y el navegador intenta
  // navegar atr√°s a una p√°gina vieja, redirigimos al MAIN_PAGE.
  window.addEventListener('popstate', () => {
    try {
      const ref = document.referrer || '';
      if (ref && !ref.includes(location.hostname)) {
        // referrer externo: forzamos al MAIN_PAGE
        location.href = MAIN_PAGE;
      }
    } catch (e) {
      location.href = MAIN_PAGE;
    }
  }, {passive: true});
}

/* ----------------------------
   Evento DOMContentLoaded
   ---------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  initLangSelector();

  // aseguramos que los enlaces externos se abran en la misma pesta√±a
  const btnGoogle = document.getElementById('btnGoogle');
  const btnPrivate = document.getElementById('btnPrivate');
  const openShare = document.getElementById('openShare');

  // btnGoogle -> a Google Maps shortlink (misma pesta√±a)
  btnGoogle.addEventListener('click', (e) => {
    e.preventDefault();
    navigateSameTab(GOOGLE_MAPS_SHORT);
  });

  // btnPrivate -> formulario Tally (misma pesta√±a)
  btnPrivate.addEventListener('click', (e) => {
    e.preventDefault();
    const lang = document.documentElement.lang || 'es';
    const url = TALLY_LINKS[lang] || TALLY_LINKS['es'];
    navigateSameTab(url);
  });

  // openShare es interno (compartir.html). Lo dejamos navegando normal,
  // pero interceptamos su click para a√±adir un pushState previo que
  // ayuda con el historial en algunos navegadores.
  openShare.addEventListener('click', (e) => {
    // No prevenir navegaci√≥n; a√±adimos un estado v√°lido para que history.back() funcione bien
    history.replaceState({fromMain:true}, '');
    // navigation proceeds to compartir.html as usual
  });

  // Si se pulsa el bot√≥n "atr√°s" (si tuvieras uno en esta p√°gina), puedes usar:
  // (ejemplo si a√±ades un bot√≥n con clase .back en otras p√°ginas que controles)
  // document.querySelectorAll('.back').forEach(b => b.addEventListener('click', e => { e.preventDefault(); goBackToMain(MAIN_PAGE); }));

  // Manejo global de popstate/referrer para evitar volver a pesta√±as antiguas
  handlePopStateFallback();
});

/* ----------------------------
   (opcional) Si esta p√°gina se carga y venimos desde ventana externa,
   podemos limpiar la marca 'cameFromMain' para evitar confusi√≥n.
   ---------------------------- */
window.addEventListener('pageshow', () => {
  try { sessionStorage.removeItem('cameFromMain'); } catch(e){}
});
</script>
</body>
</html>

