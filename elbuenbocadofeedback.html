<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#a0715e" />
<title>Feedback - El Buen Bocado</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --brand-color: #a0715e;
    
    --bg-body: #fffbf2;
    --bg-card: #ffffff;
    --text-main: #3e2b26;
    --text-sec: #8d6e63;
    --border: #e6ddd0;
    
    --shadow-card: 0 15px 35px -5px rgba(62, 43, 38, 0.08);
    --btn-text: #ffffff;
  }

  [data-theme="dark"] {
    --bg-body: #1e1b1a;
    --bg-card: #2d2420;
    --text-main: #f3e5dc;
    --text-sec: #d7ccc8;
    --border: #3e2b26;
    --shadow-card: 0 10px 25px -5px rgba(0,0,0,0.3);
  }

  *, *::before, *::after { box-sizing: border-box; }

  html { height: 100%; }

  body {
    margin: 0; 
    font-family: 'Outfit', sans-serif;
    background: var(--bg-body);
    color: var(--text-main);
    
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: flex-start; 
    
    min-height: 100vh;
    min-height: 100dvh;
    
    padding-top: max(20px, env(safe-area-inset-top));
    padding-bottom: max(30px, env(safe-area-inset-bottom));
    padding-left: 20px;
    padding-right: 20px;
    
    transition: background 0.3s, color 0.3s;
  }

  .top-controls {
    width: 100%; 
    max-width: 360px;
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    margin-bottom: 20px;
    margin-top: 10px;
  }

  .back-btn {
    background: transparent; border: none; font-size: 1.5rem;
    cursor: pointer; color: var(--text-main); padding: 5px;
    transition: transform 0.2s;
    line-height: 1;
    display: flex; align-items: center;
  }
  .back-btn:active { transform: scale(0.9); }

  .theme-btn {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text-main); width: 36px; height: 36px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: transform 0.2s; font-size: 1.2rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .theme-btn:active { transform: scale(0.9); }

  /* --- TARJETA DEL FORMULARIO --- */
  .form-card {
    background: var(--bg-card); 
    width: 100%; max-width: 360px;
    border-radius: 24px; padding: 30px 25px;
    box-shadow: var(--shadow-card); border: 1px solid var(--border);
    text-align: center;
    animation: fadeInUp 0.5s ease-out;
    
    margin-top: auto; margin-bottom: auto;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  h1 { margin: 0 0 10px; font-size: 1.6em; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
  p.subtitle { margin: 0 0 30px; font-size: 0.95em; color: var(--text-sec); line-height: 1.5; font-weight: 400; }

  /* --- ESTRELLAS --- */
  .star-container {
    display: flex; justify-content: center; gap: 8px;
    margin-bottom: 30px;
  }
  
  .star {
    font-size: 2.5em; cursor: pointer; color: var(--border);
    transition: transform 0.2s, color 0.2s;
    line-height: 1;
    user-select: none;
  }
  
  .star.active { color: #FFC107; }
  .star:hover { transform: scale(1.1); }

  /* --- INPUTS --- */
  .input-group { margin-bottom: 25px; text-align: left; }
  label { display: block; font-weight: 700; font-size: 0.9em; margin-bottom: 8px; color: var(--text-main); }
  
  textarea {
    width: 100%; padding: 16px; border-radius: 16px;
    border: 2px solid var(--border); background: var(--bg-body);
    font-family: inherit; font-size: 1em; color: var(--text-main);
    resize: none; outline: none; height: 120px;
    transition: border-color 0.3s, background 0.3s;
    appearance: none;
  }
  
  textarea:focus { border-color: var(--brand-color); background: var(--bg-card); }

  /* --- BOT√ìN --- */
  button[type="submit"] {
    width: 100%; padding: 16px; border-radius: 16px; border: none;
    font-size: 1.1em; font-weight: 700; color: white;
    background: var(--brand-color); cursor: pointer;
    box-shadow: 0 10px 25px -5px rgba(160, 113, 94, 0.4);
    transition: transform 0.2s, opacity 0.2s;
    font-family: 'Outfit', sans-serif;
    appearance: none;
  }
  
  button:disabled { opacity: 0.7; cursor: wait; transform: scale(0.98); }
  button:active { transform: scale(0.96); }

</style>
</head>
<body>

<div class="top-controls">
  <button class="back-btn" onclick="history.back()">&#8592;</button>
  <button class="theme-btn" id="themeBtn">‚òÄÔ∏è</button>
</div>

<form class="form-card" id="feedbackForm">
  <h1 id="pageTitle">Tu Opini√≥n</h1>
  <p class="subtitle" id="txtSubtitle">Ay√∫danos a mejorar cont√°ndonos tu experiencia de hoy.</p>

  <div class="input-group" style="text-align:center">
    <label id="lblRating">¬øC√≥mo fue tu experiencia general? *</label>
    <div class="star-container" id="starContainer">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
    </div>
    <input type="hidden" id="ratingInput" required>
  </div>

  <div class="input-group">
    <label id="lblComment">¬øQu√© podemos mejorar? *</label>
    <textarea id="commentInput" placeholder="..." required></textarea>
  </div>

  <button type="submit" id="submitBtn">Enviar Comentario</button>
</form>

<div style="height: 30px; width: 100%;"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- CONFIGURACI√ìN SUPABASE ---
const SUPABASE_URL = "https://xfylujdfpmajnbmuiebv.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhmeWx1amRmcG1ham5ibXVpZWJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTczMTEsImV4cCI6MjA4NzM3MzMxMX0.S6NLD1pyObNpg_sRD60Od8q7MmNWMMLnwq8YLVEhtew"; 
const miSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const translations = {
  es: {
    title: "Tu Opini√≥n", subtitle: "Ay√∫danos a mejorar cont√°ndonos tu experiencia de hoy.",
    lblRating: "¬øC√≥mo fue tu experiencia general? *", lblComment: "¬øQu√© podemos mejorar? *",
    placeholder: "La comida estaba...", submit: "Enviar Comentario", sending: "Enviando...",
    alertStar: "Por favor, selecciona una puntuaci√≥n de estrellas.", alertComment: "Por favor, escribe un comentario."
  },
  en: {
    title: "Your Opinion", subtitle: "Help us improve by sharing your experience today.",
    lblRating: "How was your overall experience? *", lblComment: "What can we improve? *",
    placeholder: "The food was...", submit: "Send Feedback", sending: "Sending...",
    alertStar: "Please select a star rating.", alertComment: "Please write a comment."
  },
  // ... (puedes mantener el resto de tus idiomas aqu√≠ igual que los ten√≠as)
};

let currentLang = 'es';

function init() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('themeBtn').innerText = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

  currentLang = localStorage.getItem('userLang') || navigator.language.slice(0, 2);
  if (!translations[currentLang]) currentLang = 'es';
  translateUI();
}

function translateUI() {
  const t = translations[currentLang];
  document.getElementById('pageTitle').innerText = t.title;
  document.getElementById('txtSubtitle').innerText = t.subtitle;
  document.getElementById('lblRating').innerText = t.lblRating;
  document.getElementById('lblComment').innerText = t.lblComment;
  document.getElementById('commentInput').placeholder = t.placeholder;
  document.getElementById('submitBtn').innerText = t.submit;
}

document.getElementById('themeBtn').onclick = () => {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  document.getElementById('themeBtn').innerText = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('theme', next);
};

// L√≥gica de estrellas
const stars = document.querySelectorAll('.star');
const ratingInput = document.getElementById('ratingInput');
stars.forEach(star => {
  star.addEventListener('click', () => {
    const val = parseInt(star.dataset.value);
    ratingInput.value = val;
    stars.forEach(s => s.classList.toggle('active', parseInt(s.dataset.value) <= val));
  });
});

// ENV√çO A SUPABASE
const form = document.getElementById('feedbackForm');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const t = translations[currentLang];

  if (!ratingInput.value) { alert(t.alertStar); return; }
  const comment = document.getElementById('commentInput').value.trim();
  if (!comment) { alert(t.alertComment); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerText = t.sending;

  // Creamos el objeto con los datos para tu base de datos
  const nuevaResena = {
      valoracion: parseInt(ratingInput.value),
      comentario: comment,
      restaurant_slug: "el-buen-bocado" // <-- Etiqueta vital para saber a qui√©n va
  };

  // Insertamos en Supabase
  const { error } = await miSupabase.from('resenas').insert([nuevaResena]);

  if (error) {
      console.error("Error al guardar:", error.message);
      alert("Hubo un problema al enviar tu rese√±a. Int√©ntalo de nuevo.");
      btn.disabled = false;
      btn.innerText = t.submit;
      return;
  }

  // Redirigir a agradecimiento si todo sali√≥ bien
  window.location.href = "elbuenbocadoagradecimiento.html";
});

window.onload = init;
</script>
</body>
</html>